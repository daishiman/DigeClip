# メール&パスワード ログイン API

- **HTTPメソッド**: `POST`
- **エンドポイント**: `/api/auth/login`
- **機能概要**: ログインし、JWT発行
- **認証要否**: **不要**(guest)

## リクエスト

**Request**: `IAuthLoginRequest`
```ts
export interface IAuthLoginRequest {
  email: string;
  password: string;
}
```

**例 (リクエストJSON)**
```jsonc
{
  "email": "john@example.com",
  "password": "MySecret123"
}
```

## レスポンス

**Response**: `IAuthLoginResponse`
```ts
export interface IAuthLoginResponse {
  userId: number;
  role: "user" | "admin";
  token: string;       // JWT
  expiresIn: number;   // 有効期限 (秒)
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "userId": 123,
  "role": "user",
  "token": "eyJhbGciOiJIUz...",
  "expiresIn": 3600
}
```

## エラー

**Error**: e.g. `401 Unauthorized` (認証失敗)
```jsonc
{
  "error": {
    "code": "E4011",
    "message": "Invalid email or password"
  }
}
```

## 実装上の注意事項

1. **入力検証**:
   - `email` フィールドが有効なメールアドレス形式であることを確認してください。
   - `password` フィールドが空でないことを確認してください。
   - 入力が無効な場合は、適切なエラーメッセージと共に `400 Bad Request` を返してください。

2. **認証処理**:
   - メールアドレスに対応するユーザーが存在するか確認してください。
   - パスワードハッシュを安全に比較してください（タイミング攻撃を防ぐため、定数時間比較を使用）。
   - 認証に失敗した場合は、具体的な理由（メールが存在しない、パスワードが間違っているなど）を明かさず、一般的なエラーメッセージを返してください。

3. **アカウント状態の確認**:
   - ユーザーアカウントが有効な状態（未削除、未停止）であることを確認してください。
   - メール確認が必要なシステムの場合、メール確認済みかどうかを確認してください。
   - アカウントが無効な場合は、適切なエラーコードとメッセージを返してください。

4. **JWTの生成**:
   - セキュアな秘密鍵を使用してJWTを生成してください。
   - JWTには少なくとも以下の情報を含めてください:
     - ユーザーID
     - ユーザーロール
     - 発行時刻（iat）
     - 有効期限（exp）
   - 有効期限は適切に設定してください（例：1時間）。

5. **ログイン試行の制限**:
   - ブルートフォース攻撃を防ぐため、同一IPアドレスまたは同一メールアドレスからの連続失敗ログイン試行を制限してください。
   - 制限に達した場合は、一時的なロックアウトを実装し、`429 Too Many Requests` エラーを返してください。

6. **ログ記録**:
   - 成功したログインと失敗したログイン試行を記録してください。
   - ログには少なくとも、タイムスタンプ、IPアドレス、ユーザーエージェント、成功/失敗の結果を含めてください。
   - 個人情報保護のため、ログにパスワードを記録しないでください。

7. **セキュリティヘッダー**:
   - レスポンスに適切なセキュリティヘッダーを含めてください:
     - `Cache-Control: no-store`
     - `Pragma: no-cache`
     - `X-Content-Type-Options: nosniff`

8. **リフレッシュトークン（オプション）**:
   - 長期間のセッション維持が必要な場合は、JWTと共にリフレッシュトークンを発行することを検討してください。
   - リフレッシュトークンはデータベースに保存し、使用時に検証してください。

9. **多要素認証（オプション）**:
   - 多要素認証が有効なユーザーの場合、追加の認証ステップを要求するレスポンスを返してください。
   - この場合、完全なJWTではなく、一時的なトークンを発行し、多要素認証完了後に正式なJWTを発行してください。

10. **エラーハンドリング**:
    - データベース接続エラーなどの内部エラーは `500 Internal Server Error` として処理し、詳細なエラーログを記録してください。
    - エラーメッセージにはセキュリティ上の機密情報を含めないよう注意してください。