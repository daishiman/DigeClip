# AIモデル削除 API

- **HTTPメソッド**: `DELETE`
- **エンドポイント**: `/api/admin/ai_models/[id]`
- **機能概要**: 既存のAIモデルをシステムから削除
- **認証要否**: **要**(admin)

## リクエスト

**Path Parameter**:
- `id`: 削除するAIモデルのID (必須)

## レスポンス

**Response**: `IAdminDeleteAIModelResponse`
```ts
export interface IAdminDeleteAIModelResponse {
  message: string;
  id: number;
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "message": "AI model successfully deleted",
  "id": 3
}
```

## エラー

**Error**: e.g. `404 Not Found`
```jsonc
{
  "error": {
    "code": "E4041",
    "message": "AI model not found"
  }
}
```

**Error**: e.g. `400 Bad Request`
```jsonc
{
  "error": {
    "code": "E4003",
    "message": "Cannot delete model that is set as default for capabilities"
  }
}
```

## 実装上の注意事項

1. **認証・認可**:
   - 管理者権限を持つユーザーのみアクセス可能なエンドポイントです。
   - リクエスト処理前に必ず認証トークンを検証し、管理者権限を確認してください。

2. **パスパラメータの検証**:
   - `id` パラメータは数値であることを確認してください。
   - 不正な形式の場合は `400 Bad Request` を返してください。

3. **モデル存在確認**:
   - 指定された `id` のAIモデルが存在するか確認してください。
   - 存在しない場合は `404 Not Found` エラーを返してください。

4. **使用中チェック**:
   - 削除対象のモデルが現在システムで使用されていないことを確認してください:
     - デフォルトモデルとして設定されていないか（`default_for` が空か）
     - 現在処理中のコンテンツで使用されていないか
     - 定期的なジョブで使用されるよう設定されていないか
   - 使用中の場合は `400 Bad Request` エラーを返し、詳細な理由を提供してください。

5. **強制削除オプション**:
   - 将来的な拡張として、使用中のモデルも強制的に削除できるクエリパラメータ（例：`?force=true`）の実装を検討してください。
   - 強制削除を実装する場合は、代替モデルの設定など、必要な対応策も実装してください。

6. **トランザクション処理**:
   - 削除操作はトランザクション内で実行し、エラー時にはロールバックしてください。
   - 特に関連するデフォルト設定の更新など、複数のテーブルを更新する場合はトランザクションが重要です。

7. **関連データの処理**:
   - モデルの使用履歴や統計情報など、関連するデータの処理方針を決定してください:
     - 完全に削除する
     - 匿名化して保持する
     - そのまま保持する（外部キー制約を調整）
   - 選択した方針を一貫して実装してください。

8. **ソフトデリート検討**:
   - 完全に削除するのではなく、`deleted_at` フラグを設定するソフトデリートの実装を検討してください。
   - これにより、誤削除からの復旧や履歴の保持が容易になります。

9. **デフォルトモデルの再設定**:
   - モデルが一部の機能のデフォルトとして設定されていた場合、代替のデフォルトモデルを自動的に設定するか、明示的なエラーを返すかを決定してください。
   - 自動設定する場合は、選択ロジックを明確にし、ログに記録してください。

10. **監査ログ**:
    - 誰がいつどのAIモデルを削除したかを記録する監査ログを実装してください。
    - ログには少なくとも、操作者ID、操作日時、削除されたモデルID、モデル名を含めてください。

11. **キャッシュ管理**:
    - モデル情報のキャッシュがある場合、削除後にキャッシュを無効化してください。
    - 特にモデルリストや設定情報のキャッシュが影響を受ける可能性があります。

12. **エラー処理**:
    - 削除中に発生する可能性のある様々なエラーケースを考慮し、適切なエラーメッセージを返してください。
    - データベースエラーなどの内部エラーは `500 Internal Server Error` として処理し、詳細なエラーログを記録してください。