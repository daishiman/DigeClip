# タグ追加 API

- **HTTPメソッド**: `POST`
- **エンドポイント**: `/api/user/contents/[id]/tags`
- **機能概要**: コンテンツにタグを追加
- **認証要否**: **要**(user/admin)

## リクエスト

**Request**: `IUserAddTagRequest`
```ts
export interface IUserAddTagRequest {
  tagName: string;
}
```

**例 (リクエストJSON)**
```jsonc
{
  "tagName": "AI"
}
```

## レスポンス

**Response**: `IUserAddTagResponse`
```ts
export interface IUserAddTagResponse {
  message: string;
  contentId: number;
  tagName: string;
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "message": "Tag added to content",
  "contentId": 203,
  "tagName": "AI"
}
```

## エラー

**Error**: e.g. `404 Not Found` (コンテンツが見つからない)
```jsonc
{
  "error": {
    "code": "E4042",
    "message": "Content not found"
  }
}
```

## 実装上の注意事項

1. **認証・認可**:
   - リクエスト処理前に必ず認証トークンを検証してください。
   - 無効なトークンや期限切れのトークンの場合は、`401 Unauthorized` エラーを返してください。
   - ユーザーが自分のコンテンツのみにタグを追加できるように、認証されたユーザーIDとコンテンツの所有者IDを照合してください。
   - 管理者ユーザーの場合は、すべてのコンテンツへのタグ追加を許可することを検討してください。

2. **パスパラメータの検証**:
   - `id` パラメータが数値であることを確認してください。
   - 不正な形式の場合は `400 Bad Request` を返してください。

3. **入力検証**:
   - `tagName` フィールドが空でないことを確認してください。
   - `tagName` の長さに制限を設けることを検討してください（例：最大50文字）。
   - 入力が無効な場合は、適切なエラーメッセージと共に `400 Bad Request` を返してください。

4. **コンテンツ存在確認**:
   - 指定された `id` のコンテンツが存在するか確認してください。
   - 存在しない場合は `404 Not Found` エラーを返してください。
   - 存在するが、ユーザーがアクセス権を持たない場合は `403 Forbidden` エラーを返してください。

5. **タグ存在確認**:
   - 指定された `tagName` のタグがシステムに存在するか確認してください。
   - 存在しない場合は、新しいタグを作成するか、エラーを返すかのポリシーを決定してください。
   - 新しいタグを作成する場合は、`tags` テーブルに挿入してください。スキーマ設計では、`tags` テーブルには `name`, `color`, `created_at` カラムがあります。

6. **重複チェック**:
   - 指定されたコンテンツに既に同じタグが付けられていないか確認してください。
   - 重複がある場合は、成功レスポンスを返すか、エラーを返すかのポリシーを決定してください。
   - 推奨: 重複の場合でも成功レスポンスを返し、冪等性を確保する。

7. **データベース操作**:
   - コンテンツとタグの関連付けは `content_tags` テーブルに挿入してください。スキーマ設計では、`content_tags` テーブルには `content_id`, `tag_id`, `created_at` カラムがあります。
   - 挿入操作はトランザクション内で実行し、エラー時にはロールバックしてください。
   - 特に新しいタグを作成する場合は、トランザクションが重要です。

8. **タグ数の制限**:
   - 1つのコンテンツに付けられるタグの最大数に制限を設けることを検討してください（例：最大10個）。
   - 制限に達した場合は、適切なエラーメッセージと共に `400 Bad Request` を返してください。

9. **タグの正規化**:
   - タグ名の先頭と末尾の空白を削除してください。
   - 大文字・小文字の扱いを統一してください（例：すべて小文字に変換）。
   - 特殊文字の扱いに関するポリシーを決定してください。

10. **ログ記録**:
    - タグ追加操作を記録してください。
    - ログには少なくとも、タイムスタンプ、ユーザーID、コンテンツID、追加されたタグ名を含めてください。

11. **エラーハンドリング**:
    - データベース接続エラーなどの内部エラーは `500 Internal Server Error` として処理し、詳細なエラーログを記録してください。
    - エラーメッセージにはセキュリティ上の機密情報を含めないよう注意してください。

12. **パフォーマンス考慮事項**:
    - タグの追加は比較的軽量な操作ですが、高頻度で実行される可能性があります。
    - 必要に応じて、キャッシュの無効化や更新を行ってください。

13. **自動タグ付けとの連携**:
    - システムに自動タグ付け機能がある場合、手動で追加されたタグと自動タグの区別を検討してください。
    - 例えば、`content_tags` テーブルに `is_auto_tagged` フラグを追加するなど。ただし、現在のスキーマ設計ではこのカラムは定義されていないため、必要に応じてスキーマを拡張してください。

14. **レスポンス形式**:
    - 成功時のレスポンスには、追加されたタグの情報を含めてください。
    - これにより、クライアント側での状態更新が容易になります。

15. **ユーザーとコンテンツの関連付け**:
    - スキーマ設計では `contents` テーブルに `user_id` カラムが明示的に定義されていないため、コンテンツとユーザーの関連付けを適切に管理するための追加テーブルまたはカラムを検討してください。
    - 例えば、`user_contents` という中間テーブルを作成するか、`contents` テーブルに `user_id` カラムを追加することを検討してください。