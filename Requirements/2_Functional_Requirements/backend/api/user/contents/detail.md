# コンテンツ詳細取得 API

- **HTTPメソッド**: `GET`
- **エンドポイント**: `/api/user/contents/[id]`
- **機能概要**: 特定コンテンツの詳細情報と要約を取得
- **認証要否**: **要**(user/admin)

## リクエスト

**Request**: パスパラメータとして `id` を含む

## レスポンス

**Response**:
```ts
export interface ISummaryItem {
  aiModelId: number;
  stage: string;  // e.g. "overview" / "heading" / "detail"
  summaryText: string;
}

export interface IUserGetContentDetailResponse {
  id: number;
  title: string;
  url: string;
  raw_text?: string;
  metadata?: {
    thumbnail?: string;
    [key: string]: any;
  };
  tags: string[];
  status: string;
  summaries: ISummaryItem[];
  notifiedAt?: string;
  published_at?: string;
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "id": 42,
  "title": "AIの最新動向 2025年版",
  "url": "https://www.youtube.com/watch?v=abc123",
  "raw_text": "本日は2025年のAI業界の最新動向についてお話しします...(省略)...",
  "metadata": {
    "thumbnail": "https://i.ytimg.com/vi/abc123/maxresdefault.jpg",
    "duration": 1234,
    "channelName": "テックチャンネル"
  },
  "tags": ["AI", "テクノロジー"],
  "status": "summarized",
  "summaries": [
    {
      "aiModelId": 1,
      "stage": "overview",
      "summaryText": "この動画は2025年におけるAI業界の主要な発展について解説している。特に生成AIの進化、自律システムの普及、倫理的枠組みの標準化について重点的に触れている。"
    },
    {
      "aiModelId": 1,
      "stage": "detail",
      "summaryText": "1. 生成AIの進化: マルチモーダルモデルが標準となり...(省略)...\n2. 自律システムの普及: 家庭用ロボットの普及率が先進国で20%を突破...(省略)...\n3. 倫理的枠組み: ISO/IEC 42001がグローバルスタンダードとして...(省略)..."
    }
  ],
  "notifiedAt": "2025-03-10T15:00:00Z",
  "published_at": "2025-03-10T14:30:00Z"
}
```

## エラー

**Error**: e.g. `404 Not Found` (コンテンツが見つからない)
```jsonc
{
  "error": {
    "code": "E4042",
    "message": "Content not found"
  }
}
```

## 実装上の注意事項

1. **認証・認可**:
   - リクエスト処理前に必ず認証トークンを検証してください。
   - 無効なトークンや期限切れのトークンの場合は、`401 Unauthorized` エラーを返してください。
   - ユーザーが自分のコンテンツのみにアクセスできるように、認証されたユーザーIDとコンテンツの所有者IDを照合してください。
   - 管理者ユーザーの場合は、すべてのコンテンツへのアクセスを許可することを検討してください。

2. **パスパラメータの検証**:
   - `id` パラメータが数値であることを確認してください。
   - 不正な形式の場合は `400 Bad Request` を返してください。

3. **コンテンツ存在確認**:
   - 指定された `id` のコンテンツが存在するか確認してください。
   - 存在しない場合は `404 Not Found` エラーを返してください。
   - 存在するが、ユーザーがアクセス権を持たない場合は `403 Forbidden` エラーを返してください。

4. **データベースアクセス**:
   - コンテンツの基本情報は `contents` テーブルから取得してください。
   - タグ情報は `content_tags` テーブルと `tags` テーブルを結合して取得してください。
   - 要約情報は `summaries` テーブルから取得してください。
   - 複数のテーブルからデータを取得する場合、効率的なクエリを設計してください。

5. **要約データの処理**:
   - 要約データは `stage` ごとに整理して返してください。スキーマ設計では、`stage` カラムに "overview", "heading", "detail" などの値が想定されています。
   - 複数のAIモデルによる要約がある場合、最新または最も品質の高いものを優先することを検討してください。
   - 要約テキストが非常に長い場合、適切な長さに制限することを検討してください。

6. **生テキストの処理**:
   - `raw_text` フィールドは非常に大きくなる可能性があります。必要に応じて、長さを制限するか、別のエンドポイントで取得できるようにすることを検討してください。
   - テキストエンコーディングの問題に注意し、UTF-8エンコーディングを使用してください。

7. **メタデータの処理**:
   - メタデータは `metadata` カラムにJSONBとして保存されています。データベースから取得後、適切にパースしてください。
   - メタデータのスキーマはソースタイプによって異なる可能性があるため、柔軟な処理を実装してください。
   - クライアントに返すメタデータは、必要最小限の情報に制限することを検討してください（特に大きなメタデータの場合）。

8. **日付フォーマット**:
   - すべての日時フィールド（published_at, notifiedAt）は ISO 8601 形式（YYYY-MM-DDThh:mm:ssZ）で返してください。
   - タイムゾーンは UTC を使用してください。

9. **ステータスチェック**:
   - コンテンツのステータスが "summarized" でない場合、`summaries` フィールドが空になる可能性があります。
   - ステータスに応じて適切なレスポンスを返してください（例：処理中の場合は進捗情報を含めるなど）。

10. **エラーハンドリング**:
    - データベース接続エラーなどの内部エラーは `500 Internal Server Error` として処理し、詳細なエラーログを記録してください。
    - エラーメッセージにはセキュリティ上の機密情報を含めないよう注意してください。

11. **パフォーマンス最適化**:
    - 複数のテーブルからデータを取得する必要があるため、クエリのパフォーマンスに注意してください。
    - 必要に応じて、以下の最適化を検討してください:
      - 適切なインデックスを使用する
      - 結果をキャッシュする（短時間のTTLで）
      - 大きなテキストフィールドは必要な場合のみ取得する

12. **セキュリティ考慮事項**:
    - URLやメタデータに含まれる可能性のある悪意のあるスクリプトに対して、適切なエスケープ処理を行ってください。
    - 特に `raw_text` フィールドには、ユーザー生成コンテンツが含まれる可能性があるため、XSS攻撃を防ぐための対策を講じてください。

13. **アクセスログ**:
    - コンテンツへのアクセスを記録し、ユーザーの閲覧履歴や人気コンテンツの分析に使用することを検討してください。
    - ログには少なくとも、タイムスタンプ、ユーザーID、コンテンツID、アクセス元IPアドレスを含めてください。

14. **ユーザーとコンテンツの関連付け**:
    - スキーマ設計では `contents` テーブルに `user_id` カラムが明示的に定義されていないため、コンテンツとユーザーの関連付けを適切に管理するための追加テーブルまたはカラムを検討してください。
    - 例えば、`user_contents` という中間テーブルを作成するか、`contents` テーブルに `user_id` カラムを追加することを検討してください。