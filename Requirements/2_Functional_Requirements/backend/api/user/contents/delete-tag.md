# タグ削除 API

- **HTTPメソッド**: `DELETE`
- **エンドポイント**: `/api/user/contents/[id]/tags/[tagName]`
- **機能概要**: コンテンツからタグを削除
- **認証要否**: **要**(user/admin)

## リクエスト

**Request**: パスパラメータとして `id` と `tagName` を含む

## レスポンス

**Response**: `IUserDeleteTagResponse`
```ts
export interface IUserDeleteTagResponse {
  message: string;
  contentId: number;
  tagName: string;
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "message": "Tag removed from content",
  "contentId": 203,
  "tagName": "AI"
}
```

## エラー

**Error**: e.g. `404 Not Found` (タグが見つからない)
```jsonc
{
  "error": {
    "code": "E4043",
    "message": "Tag not found on this content"
  }
}
```

## 実装上の注意事項

1. **認証・認可**:
   - リクエスト処理前に必ず認証トークンを検証してください。
   - 無効なトークンや期限切れのトークンの場合は、`401 Unauthorized` エラーを返してください。
   - ユーザーが自分のコンテンツのみからタグを削除できるように、認証されたユーザーIDとコンテンツの所有者IDを照合してください。
   - 管理者ユーザーの場合は、すべてのコンテンツからのタグ削除を許可することを検討してください。

2. **パスパラメータの検証**:
   - `id` パラメータが数値であることを確認してください。
   - `tagName` パラメータが空でないことを確認してください。
   - URLエンコードされた `tagName` を適切にデコードしてください。
   - 不正な形式の場合は `400 Bad Request` を返してください。

3. **コンテンツ存在確認**:
   - 指定された `id` のコンテンツが存在するか確認してください。
   - 存在しない場合は `404 Not Found` エラーを返してください。
   - 存在するが、ユーザーがアクセス権を持たない場合は `403 Forbidden` エラーを返してください。

4. **タグ関連付け確認**:
   - 指定されたコンテンツに指定された `tagName` のタグが関連付けられているか確認してください。
   - 関連付けが存在しない場合は `404 Not Found` エラーを返してください。
   - ただし、冪等性を確保するため、タグが既に削除されている場合でも成功レスポンスを返すことを検討してください。

5. **自動タグの保護（オプション）**:
   - システムによって自動的に付けられたタグ（`is_auto_tagged=true`）の削除を制限することを検討してください。
   - 自動タグを削除しようとした場合は、適切なエラーメッセージと共に `403 Forbidden` を返すか、特別な権限（管理者のみなど）を要求してください。
   - ただし、現在のスキーマ設計では `is_auto_tagged` カラムは定義されていないため、必要に応じてスキーマを拡張してください。

6. **データベース操作**:
   - コンテンツとタグの関連付けを `content_tags` テーブルから削除してください。スキーマ設計では、`content_tags` テーブルには `content_id`, `tag_id`, `created_at` カラムがあります。
   - 削除操作はトランザクション内で実行し、エラー時にはロールバックしてください。

7. **孤立タグの処理（オプション）**:
   - タグ削除後、そのタグが他のコンテンツに関連付けられていない場合（孤立タグ）、タグ自体を削除するかどうかのポリシーを決定してください。
   - 孤立タグを削除する場合は、`tags` テーブルからも削除してください。

8. **ログ記録**:
   - タグ削除操作を記録してください。
   - ログには少なくとも、タイムスタンプ、ユーザーID、コンテンツID、削除されたタグ名を含めてください。

9. **エラーハンドリング**:
   - データベース接続エラーなどの内部エラーは `500 Internal Server Error` として処理し、詳細なエラーログを記録してください。
   - エラーメッセージにはセキュリティ上の機密情報を含めないよう注意してください。

10. **パフォーマンス考慮事項**:
    - タグの削除は比較的軽量な操作ですが、高頻度で実行される可能性があります。
    - 必要に応じて、キャッシュの無効化や更新を行ってください。

11. **レスポンス形式**:
    - 成功時のレスポンスには、削除されたタグの情報を含めてください。
    - これにより、クライアント側での状態更新が容易になります。

12. **一括削除の検討**:
    - 将来的に複数のタグを一度に削除する機能が必要になる可能性があります。
    - その場合は、別のエンドポイント（例：`POST /api/user/contents/[id]/tags/batch-delete`）を検討してください。

13. **ユーザーとコンテンツの関連付け**:
    - スキーマ設計では `contents` テーブルに `user_id` カラムが明示的に定義されていないため、コンテンツとユーザーの関連付けを適切に管理するための追加テーブルまたはカラムを検討してください。
    - 例えば、`user_contents` という中間テーブルを作成するか、`contents` テーブルに `user_id` カラムを追加することを検討してください。