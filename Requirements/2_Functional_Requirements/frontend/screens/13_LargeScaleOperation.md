# 大規模運用向け画面仕様書

## 画面概要
システムの大規模運用時に必要となるモニタリングと管理機能を提供する画面です。CPU/メモリ使用率、API呼び出し回数、ストレージ使用量などのリソース監視、パフォーマンス分析、コスト管理機能を備えています。システム管理者がシステムの健全性を把握し、リソース使用の最適化やコスト削減のための意思決定を支援します。

## 画面レイアウト
```
+----------------------------------------------------------------------+
|  DigeClip > 大規模運用管理                              ユーザー名 ▼ |
+----------------------------------------------------------------------+
|                                                                      |
|  期間: [過去24時間 ▼]  更新間隔: [5分 ▼]  [自動更新 ✓]             |
|                                                                      |
|  +-------------------------------------------------------------------+
|  | システムリソース                                                 |
|  +-------------------------------------------------------------------+
|  |                                                                   |
|  | CPU使用率:                                                        |
|  | [折れ線グラフ: 時間経過に伴うCPU使用率の変化]                     |
|  | 現在: 45%  平均: 38%  最大: 78%                                  |
|  |                                                                   |
|  | メモリ使用率:                                                     |
|  | [折れ線グラフ: 時間経過に伴うメモリ使用率の変化]                  |
|  | 現在: 3.2GB/8GB (40%)  平均: 35%  最大: 65%                      |
|  |                                                                   |
|  | ディスク使用量:                                                   |
|  | [円グラフ: 使用済み/空き容量の比率]                               |
|  | 使用中: 120GB/500GB (24%)  残り: 380GB                           |
|  |                                                                   |
|  +-------------------------------------------------------------------+
|                                                                      |
|  +-------------------------------------------------------------------+
|  | API使用状況                                                      |
|  +-------------------------------------------------------------------+
|  |                                                                   |
|  | AI API呼び出し回数:                                               |
|  | [棒グラフ: 時間帯別のAPI呼び出し回数]                             |
|  | 本日合計: 1,245回  前日比: +15%                                  |
|  |                                                                   |
|  | API別呼び出し回数:                                                |
|  | [円グラフ: API別の呼び出し比率]                                   |
|  | OpenAI: 45%  Claude: 30%  Gemini: 25%                            |
|  |                                                                   |
|  | API呼び出しエラー率:                                              |
|  | [折れ線グラフ: 時間経過に伴うエラー率の変化]                      |
|  | 現在: 0.5%  平均: 0.8%  最大: 2.3%                               |
|  |                                                                   |
|  +-------------------------------------------------------------------+
|                                                                      |
|  +-------------------------------------------------------------------+
|  | コスト分析                                                       |
|  +-------------------------------------------------------------------+
|  |                                                                   |
|  | AI API利用コスト:                                                 |
|  | [棒グラフ: 日別のAPI利用コスト]                                   |
|  | 本日: $12.45  今月合計: $245.78  前月比: -5%                     |
|  |                                                                   |
|  | コスト内訳:                                                       |
|  | [円グラフ: サービス別のコスト比率]                                |
|  | OpenAI: $8.25 (66%)  Claude: $3.10 (25%)  Gemini: $1.10 (9%)     |
|  |                                                                   |
|  | コスト予測:                                                       |
|  | [折れ線グラフ: 今後のコスト予測]                                  |
|  | 今月予測: $320.50  予算上限: $500.00                             |
|  |                                                                   |
|  +-------------------------------------------------------------------+
|                                                                      |
|  +-------------------------------------------------------------------+
|  | システムアラート                                                 |
|  +-------------------------------------------------------------------+
|  |                                                                   |
|  | 現在のアラート:                                                   |
|  | ⚠️ CPU使用率が70%を超えました (2023/03/15 14:30)                 |
|  | ⚠️ API呼び出しエラー率が2%を超えました (2023/03/15 13:15)        |
|  |                                                                   |
|  | [アラート設定]                                                    |
|  |                                                                   |
|  +-------------------------------------------------------------------+
|                                                                      |
|  [レポート出力]                                                      |
|                                                                      |
+----------------------------------------------------------------------+

// モーダル: アラート設定
+--------------------------------------+
|  アラート設定                     ✕ |
+--------------------------------------+
|                                      |
|  CPU使用率アラート:                  |
|  閾値: [70] %                        |
|                                      |
|  メモリ使用率アラート:               |
|  閾値: [80] %                        |
|                                      |
|  ディスク使用量アラート:             |
|  閾値: [90] %                        |
|                                      |
|  API呼び出しエラー率アラート:        |
|  閾値: [2] %                         |
|                                      |
|  コスト上限アラート:                 |
|  閾値: [$500]                        |
|                                      |
|  通知方法:                           |
|  [✓] 画面表示                        |
|  [✓] メール通知                      |
|  [ ] Slack通知                       |
|                                      |
|  [キャンセル]        [保存]          |
|                                      |
+--------------------------------------+
```

## 機能要件
1. **期間・更新設定**
   - 表示期間の選択（過去1時間、24時間、7日間、30日間など）
   - 更新間隔の設定（1分、5分、15分、30分、手動）
   - 自動更新の有効/無効切り替え

2. **システムリソースモニタリング**
   - CPU使用率のリアルタイムグラフ表示
   - メモリ使用率のリアルタイムグラフ表示
   - ディスク使用量の視覚的表示
   - 現在値、平均値、最大値の数値表示

3. **API使用状況モニタリング**
   - AI API呼び出し回数のグラフ表示
   - API別の呼び出し比率の表示
   - エラー率の時系列表示
   - 前日・前週比などの比較情報

4. **コスト分析**
   - AI API利用コストの日別・月別表示
   - サービス別のコスト内訳
   - 将来のコスト予測
   - 予算上限との比較

5. **システムアラート**
   - 重要なアラートの表示
   - アラート設定の管理（閾値設定）
   - 通知方法の設定（画面、メール、Slackなど）

6. **レポート出力**
   - システム状態レポートの生成
   - PDF、CSV、Excelなど複数形式での出力
   - 定期レポート設定（オプション）

## バリデーション要件
1. **アラート設定**
   - CPU使用率: 1〜100の整数
   - メモリ使用率: 1〜100の整数
   - ディスク使用量: 1〜100の整数
   - API呼び出しエラー率: 0.1〜100の小数
   - コスト上限: 1以上の数値

2. **期間設定**
   - 有効な期間選択
   - 開始日 <= 終了日（カスタム期間の場合）

## エラーメッセージ
- 設定エラー:
  - 「有効な閾値を入力してください」
  - 「コスト上限は正の数値で入力してください」
  - 「通知方法を最低1つ選択してください」

- データ取得エラー:
  - 「システムリソースデータの取得に失敗しました」
  - 「API使用状況データの取得に失敗しました」
  - 「コストデータの取得に失敗しました」
  - 「アラート情報の取得に失敗しました」

- レポート生成エラー:
  - 「レポート生成に失敗しました」
  - 「選択した期間のデータが不足しています」

## API連携
1. **システムリソース取得API**
   - エンドポイント: `/api/monitoring/system-resources`
   - メソッド: GET
   - クエリパラメータ: `period`, `interval`
   - レスポンス:
     ```json
     {
       "cpu": {
         "current": 45,
         "average": 38,
         "max": 78,
         "timeSeries": [
           {"timestamp": "2023-03-15T14:00:00Z", "value": 42},
           {"timestamp": "2023-03-15T14:05:00Z", "value": 45},
           // ...
         ]
       },
       "memory": {
         "current": 40,
         "average": 35,
         "max": 65,
         "total": 8589934592,
         "used": 3435973836,
         "timeSeries": [
           {"timestamp": "2023-03-15T14:00:00Z", "value": 38},
           {"timestamp": "2023-03-15T14:05:00Z", "value": 40},
           // ...
         ]
       },
       "disk": {
         "total": 536870912000,
         "used": 128849018880,
         "free": 408021893120,
         "usagePercent": 24
       }
     }
     ```

2. **API使用状況取得API**
   - エンドポイント: `/api/monitoring/api-usage`
   - メソッド: GET
   - クエリパラメータ: `period`, `interval`
   - レスポンス:
     ```json
     {
       "totalCalls": {
         "today": 1245,
         "yesterday": 1082,
         "changePercent": 15,
         "timeSeries": [
           {"timestamp": "2023-03-15T14:00:00Z", "value": 42},
           {"timestamp": "2023-03-15T15:00:00Z", "value": 56},
           // ...
         ]
       },
       "callsByService": {
         "openai": {"count": 560, "percent": 45},
         "claude": {"count": 373, "percent": 30},
         "gemini": {"count": 312, "percent": 25}
       },
       "errorRate": {
         "current": 0.5,
         "average": 0.8,
         "max": 2.3,
         "timeSeries": [
           {"timestamp": "2023-03-15T14:00:00Z", "value": 0.6},
           {"timestamp": "2023-03-15T15:00:00Z", "value": 0.5},
           // ...
         ]
       }
     }
     ```

3. **コスト分析API**
   - エンドポイント: `/api/monitoring/cost-analysis`
   - メソッド: GET
   - クエリパラメータ: `period`
   - レスポンス:
     ```json
     {
       "costs": {
         "today": 12.45,
         "thisMonth": 245.78,
         "lastMonth": 258.72,
         "changePercent": -5,
         "dailySeries": [
           {"date": "2023-03-10", "value": 10.25},
           {"date": "2023-03-11", "value": 11.50},
           // ...
         ]
       },
       "costsByService": {
         "openai": {"cost": 8.25, "percent": 66},
         "claude": {"cost": 3.10, "percent": 25},
         "gemini": {"cost": 1.10, "percent": 9}
       },
       "prediction": {
         "thisMonth": 320.50,
         "nextMonth": 335.20,
         "budget": 500.00
       }
     }
     ```

4. **アラート取得API**
   - エンドポイント: `/api/monitoring/alerts`
   - メソッド: GET
   - レスポンス:
     ```json
     {
       "activeAlerts": [
         {
           "id": 1,
           "type": "cpu_usage",
           "message": "CPU使用率が70%を超えました",
           "timestamp": "2023-03-15T14:30:00Z",
           "value": 78,
           "threshold": 70,
           "severity": "warning"
         },
         {
           "id": 2,
           "type": "api_error_rate",
           "message": "API呼び出しエラー率が2%を超えました",
           "timestamp": "2023-03-15T13:15:00Z",
           "value": 2.3,
           "threshold": 2,
           "severity": "warning"
         }
       ],
       "settings": {
         "cpu_usage": {"threshold": 70, "enabled": true},
         "memory_usage": {"threshold": 80, "enabled": true},
         "disk_usage": {"threshold": 90, "enabled": true},
         "api_error_rate": {"threshold": 2, "enabled": true},
         "cost_limit": {"threshold": 500, "enabled": true},
         "notifications": {
           "ui": true,
           "email": true,
           "slack": false
         }
       }
     }
     ```

5. **アラート設定更新API**
   - エンドポイント: `/api/monitoring/alerts/settings`
   - メソッド: PUT
   - リクエストボディ: 更新する設定オブジェクト
   - レスポンス: 更新された設定オブジェクト

6. **レポート生成API**
   - エンドポイント: `/api/monitoring/report`
   - メソッド: POST
   - リクエストボディ:
     ```json
     {
       "period": "last_30_days",
       "format": "pdf",
       "sections": ["system_resources", "api_usage", "cost_analysis"]
     }
     ```
   - レスポンス: ファイルダウンロードまたはダウンロードURL

## UI/UX考慮事項
1. **ダッシュボードレイアウト**
   - 重要情報を上部に配置
   - 論理的なグループ分け
   - 折りたたみ可能なセクション

2. **グラフ表示**
   - インタラクティブなグラフ（ズーム、ホバー情報）
   - 適切な色使いと凡例
   - 異常値の強調表示

3. **アラート表示**
   - 重要度に応じた視覚的区別（色、アイコン）
   - クリック可能なアラート（詳細表示）
   - 既読/未読の区別

4. **リアルタイム更新**
   - スムーズなデータ更新アニメーション
   - 更新タイミングの視覚的フィードバック
   - 手動更新ボタンの提供

5. **アクセシビリティ**
   - グラフデータの代替テキスト
   - キーボード操作のサポート
   - 色覚異常に配慮した配色

## 実装上の注意事項
1. **パフォーマンス最適化**
   - 大量のデータポイントの効率的な表示
   - グラフ描画の最適化
   - データのキャッシュ戦略

2. **リアルタイムデータ取得**
   - WebSocketまたはポーリングの適切な実装
   - 接続切断時の再接続ロジック
   - バックグラウンドデータ取得

3. **グラフライブラリ選定**
   - D3.js, Chart.js, Recharts などの適切な選択
   - カスタマイズ性と性能のバランス
   - 複雑なデータ可視化への対応

4. **セキュリティ対策**
   - 権限管理（管理者のみアクセス可能）
   - センシティブなコスト情報の保護
   - API呼び出し制限

5. **拡張性**
   - 新しいモニタリング指標の追加容易性
   - カスタムダッシュボード機能（将来拡張）
   - 外部モニタリングツールとの連携（オプション）

6. **テスト**
   - 大量データ時の表示テスト
   - 異常値発生時の表示テスト
   - 長時間実行時の安定性テスト