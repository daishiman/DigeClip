# ユーザー管理画面仕様書

## 画面概要
システム管理者がユーザーアカウントを管理するための画面です。複数の管理者やロールの追加・編集・削除、パスワードリセット機能などを提供します。ユーザーごとに適切な権限を設定することで、システムのセキュリティを維持しながら、複数人での運用を可能にします。

## 画面レイアウト
```
+----------------------------------------------------------------------+
|  DigeClip > ユーザー管理                                ユーザー名 ▼ |
+----------------------------------------------------------------------+
|                                                                      |
|  [+ 新規ユーザー追加]              検索: [                ]         |
|                                                                      |
|  +-------------------------------------------------------------------+
|  | ユーザー一覧                                                     |
|  +-------------------------------------------------------------------+
|  | ユーザーID     | 名前     | ロール       | 最終ログイン | 操作    |
|  +----------------+----------+--------------+--------------+---------+
|  | admin          | 管理者   | システム管理者| 2023/03/15  | 編集    |
|  | editor         | 編集者   | コンテンツ管理| 2023/03/14  | 編集 削除|
|  | viewer         | 閲覧者   | 閲覧のみ     | 2023/03/10  | 編集 削除|
|  | ...            | ...      | ...          | ...         | ...     |
|  +-------------------------------------------------------------------+
|                                                                      |
|  ページ: < 1 2 3 ... 5 >                                            |
|                                                                      |
+----------------------------------------------------------------------+

// モーダル: 新規ユーザー追加/編集
+--------------------------------------+
|  ユーザー追加/編集                ✕ |
+--------------------------------------+
|                                      |
|  ユーザーID*:                        |
|  [                             ]     |
|                                      |
|  名前*:                              |
|  [                             ]     |
|                                      |
|  メールアドレス*:                    |
|  [                             ]     |
|                                      |
|  ロール*:                            |
|  [システム管理者 ▼]                  |
|                                      |
|  パスワード*: (新規追加時のみ)       |
|  [                             ]     |
|                                      |
|  [パスワードリセット] (編集時のみ)   |
|                                      |
|  [キャンセル]        [保存]          |
|                                      |
+--------------------------------------+

// モーダル: パスワードリセット
+--------------------------------------+
|  パスワードリセット                ✕ |
+--------------------------------------+
|                                      |
|  新しいパスワード*:                  |
|  [                             ]     |
|                                      |
|  パスワード確認*:                    |
|  [                             ]     |
|                                      |
|  [キャンセル]        [リセット]      |
|                                      |
+--------------------------------------+
```

## 機能要件
1. **ユーザー一覧表示**
   - テーブル形式で表示
   - カラム: ユーザーID、名前、ロール、最終ログイン日時、操作
   - ページネーション機能
   - 検索フィルタリング

2. **新規ユーザー追加**
   - 「新規ユーザー追加」ボタンでモーダル表示
   - 必須項目: ユーザーID、名前、メールアドレス、ロール、パスワード
   - 追加成功時は一覧に即時反映

3. **ユーザー編集**
   - 既存ユーザーの「編集」ボタンでモーダル表示
   - 現在の値をフォームに初期表示
   - パスワードは表示せず、リセットボタンを提供

4. **ユーザー削除**
   - 削除前に確認ダイアログを表示
   - システム管理者ロールは削除不可（最低1名は必要）
   - 自分自身は削除不可

5. **パスワードリセット**
   - 編集画面内の「パスワードリセット」ボタンでモーダル表示
   - 新しいパスワードと確認用パスワードを入力
   - 強度チェックと一致確認

6. **ロール管理**
   - 事前定義されたロールから選択
   - ロールごとの権限説明を表示

## バリデーション要件
1. **ユーザーID**
   - 必須入力
   - 3〜20文字の英数字
   - 重複チェック（同一IDは不可）
   - 先頭は英字のみ

2. **名前**
   - 必須入力
   - 最大50文字

3. **メールアドレス**
   - 必須入力
   - 有効なメールアドレス形式
   - 重複チェック（同一メールアドレスは不可）

4. **ロール**
   - 必須選択
   - 選択肢: "システム管理者", "コンテンツ管理者", "閲覧のみ"

5. **パスワード**
   - 必須入力（新規追加時）
   - 最小8文字
   - 英大文字、英小文字、数字、特殊文字を含む
   - パスワード確認と一致

## エラーメッセージ
- 入力検証エラー:
  - 「ユーザーIDを入力してください」
  - 「ユーザーIDは3〜20文字の英数字で入力してください」
  - 「ユーザーIDの先頭は英字にしてください」
  - 「同じユーザーIDが既に存在します」
  - 「名前を入力してください」
  - 「有効なメールアドレスを入力してください」
  - 「同じメールアドレスが既に存在します」
  - 「ロールを選択してください」
  - 「パスワードを入力してください」
  - 「パスワードは8文字以上で、英大文字、英小文字、数字、特殊文字を含める必要があります」
  - 「パスワードが一致しません」

- 操作エラー:
  - 「ユーザーの追加に失敗しました」
  - 「ユーザーの更新に失敗しました」
  - 「ユーザーの削除に失敗しました」
  - 「システム管理者は最低1名必要です」
  - 「自分自身を削除することはできません」
  - 「パスワードのリセットに失敗しました」

## API連携
1. **ユーザー一覧取得API**
   - エンドポイント: `/api/users`
   - メソッド: GET
   - クエリパラメータ: `page`, `pageSize`, `search`
   - レスポンス:
     ```json
     {
       "data": [
         {
           "id": "admin",
           "name": "管理者",
           "email": "admin@example.com",
           "role": "system_admin",
           "lastLogin": "2023-03-15T14:30:00Z"
         },
         // ...
       ],
       "pagination": {
         "page": 1,
         "pageSize": 10,
         "total": 15
       }
     }
     ```

2. **ユーザー追加API**
   - エンドポイント: `/api/users`
   - メソッド: POST
   - リクエストボディ:
     ```json
     {
       "id": "newuser",
       "name": "新規ユーザー",
       "email": "newuser@example.com",
       "role": "content_manager",
       "password": "SecureP@ss123"
     }
     ```
   - レスポンス: 作成されたユーザーオブジェクト（パスワードは含まない）

3. **ユーザー更新API**
   - エンドポイント: `/api/users/[id]`
   - メソッド: PUT
   - リクエストボディ: 更新するフィールド
   - レスポンス: 更新されたユーザーオブジェクト

4. **ユーザー削除API**
   - エンドポイント: `/api/users/[id]`
   - メソッド: DELETE
   - レスポンス: 成功時は204 No Content

5. **パスワードリセットAPI**
   - エンドポイント: `/api/users/[id]/reset-password`
   - メソッド: POST
   - リクエストボディ: `{ "password": "NewSecureP@ss123" }`
   - レスポンス: 成功時は200 OK

6. **ロール一覧API**
   - エンドポイント: `/api/roles`
   - メソッド: GET
   - レスポンス:
     ```json
     {
       "data": [
         {
           "id": "system_admin",
           "name": "システム管理者",
           "description": "すべての機能にアクセス可能"
         },
         {
           "id": "content_manager",
           "name": "コンテンツ管理者",
           "description": "コンテンツの管理のみ可能"
         },
         {
           "id": "viewer",
           "name": "閲覧のみ",
           "description": "コンテンツの閲覧のみ可能"
         }
       ]
     }
     ```

## UI/UX考慮事項
1. **ユーザー情報表示**
   - ロールに応じた視覚的な区別（アイコンや色）
   - 最終ログイン日時は相対表示（「3日前」など）

2. **パスワード入力**
   - パスワード強度インジケーター
   - 表示/非表示切り替えボタン
   - パスワード生成ヘルパー（オプション）

3. **権限説明**
   - ロール選択時に権限の詳細説明をツールチップで表示
   - 権限変更の影響を明確に伝える

4. **操作確認**
   - 重要な操作（削除、権限変更）は確認ダイアログを表示
   - 操作結果のフィードバックを明確に表示

5. **アクセシビリティ**
   - キーボード操作のサポート
   - スクリーンリーダー対応
   - 適切なラベルとARIA属性の使用

## 実装上の注意事項
1. **セキュリティ対策**
   - パスワードはハッシュ化して保存（フロントエンドでは平文表示しない）
   - CSRF対策
   - XSS対策（入力値のサニタイズ）
   - 権限チェックの徹底

2. **ユーザー管理ロジック**
   - システム管理者は最低1名必要（削除制限）
   - 自分自身の削除や権限低下を防止
   - 一括操作の考慮（将来拡張）

3. **パスワード管理**
   - パスワードポリシーの適用
   - パスワードリセット時のセキュリティ考慮
   - パスワード有効期限の管理（オプション）

4. **エラーハンドリング**
   - API通信エラーの適切な処理
   - 権限エラーの明確なフィードバック
   - 競合解決（同時編集時など）

5. **監査ログ**
   - ユーザー管理操作のログ記録
   - 重要な変更の追跡

6. **テスト**
   - 各CRUD操作のユニットテスト
   - 権限チェックのテスト
   - パスワードポリシーのテスト