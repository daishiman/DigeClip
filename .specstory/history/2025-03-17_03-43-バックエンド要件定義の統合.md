<!-- Generated by SpecStory -->

# バックエンド要件定義の統合 (2025-03-17 12:43:42)

_**User**_

@backend と @data はともにバックエンドの要件定義です。初学者のエンジニアでも実装しやすいように、構成を統合して、管理しやすい構造体としてください。

---

_**Assistant**_

バックエンドと関連データの要件定義を統合して、初学者エンジニアでも実装しやすい構造にまとめたいとのことですね。まずは両方のフォルダの内容を詳しく確認してみましょう。

---

Read file: /Users/dm/dev/dev/DigeClip/Requirements/2_Functional_Requirements/backend/0_Common_Requirements.md

---

Read file: /Users/dm/dev/dev/DigeClip/Requirements/2_Functional_Requirements/backend/1_Architecture_Overview.md

---

Read file: /Users/dm/dev/dev/DigeClip/Requirements/2_Functional_Requirements/backend/2_Technology_Stack.md

---

Read file: /Users/dm/dev/dev/DigeClip/Requirements/2_Functional_Requirements/backend/3_API_Design.md

---

Read file: /Users/dm/dev/dev/DigeClip/Requirements/2_Functional_Requirements/backend/4_External_Integration.md

---

Read file: /Users/dm/dev/dev/DigeClip/Requirements/2_Functional_Requirements/backend/5_Implementation_Patterns.md

---

Read file: /Users/dm/dev/dev/DigeClip/Requirements/2_Functional_Requirements/data/1_Database_Selection.md

---

Read file: /Users/dm/dev/dev/DigeClip/Requirements/2_Functional_Requirements/data/2_Schema_Design.md

---

Read file: /Users/dm/dev/dev/DigeClip/Requirements/2_Functional_Requirements/data/3_Data_Lifecycle.md

---

Read file: /Users/dm/dev/dev/DigeClip/Requirements/2_Functional_Requirements/data/4_Privacy_Compliance.md

---

バックエンドとデータの要件定義を統合して、初学者エンジニアでも実装しやすい構造にまとめます。

---

```diff
- 
+ # DigeClip バックエンド統合要件定義
+ 
+ ## 概要
+ 
+ このドキュメントは、DigeClipのバックエンドとデータ関連の要件を統合し、初学者エンジニアでも実装しやすい形にまとめたものです。「お金をかけずに、容易に経験の浅いエンジニアが実装できること」を最優先とし、将来的な拡張にも対応しやすい設計を目指します。
+ 
+ ## 1. アーキテクチャ概要
+ 
+ ### 1.1 基本方針
+ 
+ - **モノリシック構成**:
+   - Next.js（フロント＆バックエンド） + Supabase（DB）を1つのリポジトリ/プロジェクトで管理
+   - Vercel上でサーバレスとして動作させる
+   - 小規模から始め、必要に応じて拡張可能な設計
+ 
+ ### 1.2 レイヤー構成
+ 
+ 1. **プレゼンテーション層 (UI)**
+    - Next.jsのページコンポーネント + Tailwind CSS
+ 
+ 2. **APIレイヤー** (`/app/api/*`)
+    - Next.jsのAPI Routes (Serverless Functions)
+    - HTTPリクエストの受付と処理
+ 
+ 3. **サービスレイヤー** (`/lib/services/*`)
+    - ビジネスロジックの実装
+    - 外部APIとの連携
+ 
+ 4. **リポジトリレイヤー** (`/lib/db/repositories/*`)
+    - データアクセスロジックの抽象化
+    - クエリの実行
+ 
+ 5. **ユーティリティレイヤー** (`/lib/utils/*`)
+    - 共通機能の提供
+ 
+ ## 2. 技術スタック
+ 
+ ### 2.1 言語・フレームワーク
+ 
+ - **言語**: TypeScript 5.x
+ - **フレームワーク**: Next.js 14 (React)
+ - **バックエンドAPI**: Next.js API Routes
+ - **データベース**: Supabase (PostgreSQL)
+ - **ホスティング**: Vercel
+ 
+ ### 2.2 主要ライブラリ
+ 
+ | カテゴリ | ライブラリ | 用途 |
+ |---------|-----------|------|
+ | バリデーション | zod | スキーマバリデーション |
+ | データベース | @supabase/supabase-js | Supabase クライアント |
+ | ORM | Prisma | データベースアクセス |
+ | 認証 | jsonwebtoken | JWT認証 |
+ | HTTP | axios | 外部APIリクエスト |
+ | コンテンツ処理 | cheerio | HTMLパース |
+ | RSS | rss-parser | RSSフィード解析 |
+ | スケジューリング | node-cron | 定期実行 |
+ | AI | openai, @anthropic-ai/sdk | AI API クライアント |
+ | テスト | Jest, supertest | ユニット・統合テスト |
+ 
+ ## 3. データベース設計
+ 
+ ### 3.1 データベース選定
+ 
+ - **採用DB**: Supabase (PostgreSQL)
+   - 無料枠があり、初期コストゼロで始められる
+   - RDBの一貫性を維持できる
+   - ブラウザで操作できるSupabase Studioがあり、初心者でも操作が容易
+   - 将来的に有料プランへのアップグレードも容易
+ 
+ ### 3.2 テーブル構造
+ 
+ ```mermaid
+ erDiagram
+     sources ||--o{ contents : "1対多"
+     sources ||--o{ summaries : "1対多"
+     contents ||--o{ content_tags : "1対多"
+     tags ||--o{ content_tags : "1対多"
+     ai_models ||--o{ summaries : "1対多"
+     contents ||--o{ notifications : "1対多"
+     users ||--o{ notifications : "1対多"
+     sources ||--o| youtube_sources : "1対0または1"
+     sources ||--o| rss_sources : "1対0または1"
+     sources ||--o| arxiv_sources : "1対0または1"
+     app_settings
+ ```
+ 
+ #### 主要テーブル定義
+ 
+ 1. **sources** (監視対象の基本情報)
+    - `id`: SERIAL (主キー)
+    - `name`: VARCHAR(100) - ソース名
+    - `type`: VARCHAR(50) - ソース種別 (youtube/rss/arxiv など)
+    - `active`: BOOLEAN - 有効/無効フラグ
+    - `last_checked`: TIMESTAMP - 最終チェック日時
+    - `created_at`: TIMESTAMP - 作成日時
+    - `updated_at`: TIMESTAMP - 更新日時
+ 
+ 2. **contents** (取得したコンテンツ情報)
+    - `id`: SERIAL (主キー)
+    - `source_id`: INTEGER (外部キー) - ソースID
+    - `title`: VARCHAR(255) - コンテンツタイトル
+    - `original_url`: VARCHAR(512) - 元URL
+    - `published_at`: TIMESTAMP - 公開日時
+    - `content_text`: TEXT - 元コンテンツテキスト
+    - `status`: VARCHAR(50) - ステータス (new/summarized/error など)
+    - `created_at`: TIMESTAMP - 作成日時
+    - `updated_at`: TIMESTAMP - 更新日時
+ 
+ 3. **summaries** (要約結果)
+    - `id`: SERIAL (主キー)
+    - `content_id`: INTEGER (外部キー) - コンテンツID
+    - `ai_model_id`: INTEGER (外部キー) - AIモデルID
+    - `summary_type`: VARCHAR(50) - 要約タイプ (overview/heading/detail など)
+    - `summary_text`: TEXT - 要約テキスト
+    - `created_at`: TIMESTAMP - 作成日時
+ 
+ 4. **ai_models** (AIモデル設定)
+    - `id`: SERIAL (主キー)
+    - `name`: VARCHAR(100) - モデル名
+    - `provider`: VARCHAR(50) - プロバイダ (openai/anthropic など)
+    - `model_id`: VARCHAR(100) - モデルID (gpt-4/claude-3 など)
+    - `api_key_encrypted`: VARCHAR(512) - 暗号化されたAPIキー
+    - `active`: BOOLEAN - 有効/無効フラグ
+    - `created_at`: TIMESTAMP - 作成日時
+    - `updated_at`: TIMESTAMP - 更新日時
+ 
+ ### 3.3 データライフサイクル
+ 
+ - **保存期間**: 基本的に無期限
+ - **バックアップ**: Supabaseの自動バックアップを利用
+ - **将来拡張**: データ量が増えた場合、古いデータのアーカイブや削除を検討
+ 
+ ## 4. API設計
+ 
+ ### 4.1 基本設計
+ 
+ - **ベースURL**: `/api`
+ - **リソース命名規則**: 複数形の名詞を使用 (例: `/sources`, `/contents`)
+ - **HTTPメソッド**:
+   - GET: リソースの取得
+   - POST: リソースの作成
+   - PUT: リソースの更新（全体）
+   - PATCH: リソースの部分更新
+   - DELETE: リソースの削除
+ 
+ ### 4.2 レスポンス形式
+ 
+ #### 成功時
+ ```json
+ {
+   "data": {
+     // リソースデータ
+   },
+   "meta": {
+     // メタデータ（ページネーション情報など）
+   }
+ }
+ ```
+ 
+ #### エラー時
+ ```json
+ {
+   "error": {
+     "code": "E400",
+     "message": "ユーザーフレンドリーなエラーメッセージ",
+     "details": {
+       "field1": "フィールド固有のエラーメッセージ",
+       "field2": "フィールド固有のエラーメッセージ"
+     }
+   }
+ }
+ ```
+ 
+ ### 4.3 主要API一覧
+ 
+ #### 認証系API
+ - `POST /api/auth/register` - ユーザー登録
+ - `POST /api/auth/login` - ログイン
+ - `POST /api/auth/logout` - ログアウト
+ 
+ #### ユーザーロールAPI
+ - `GET /api/user/contents` - コンテンツ一覧取得
+ - `GET /api/user/contents/{id}` - コンテンツ詳細取得
+ - `GET /api/user/contents/{id}/summaries` - 要約一覧取得
+ 
+ #### 管理者ロールAPI
+ - `GET /api/admin/sources` - ソース一覧取得
+ - `POST /api/admin/sources` - ソース作成
+ - `PUT /api/admin/sources/{id}` - ソース更新
+ - `DELETE /api/admin/sources/{id}` - ソース削除
+ - `GET /api/admin/ai-models` - AIモデル一覧取得
+ - `POST /api/admin/ai-models` - AIモデル作成
+ 
+ ## 5. 実装パターン
+ 
+ ### 5.1 基本的なAPIエンドポイント実装パターン
+ 
+ ```typescript
+ // /api/user/contents/route.ts
+ import { NextRequest, NextResponse } from 'next/server';
+ import { withApiHandler } from '@/lib/middleware/apiHandler';
+ import { validate, schemas } from '@/lib/utils/validation';
+ import { contentService } from '@/lib/services/content/contentService';
+ 
+ async function handler(req: NextRequest) {
+   // クエリパラメータのバリデーション
+   const searchParams = req.nextUrl.searchParams;
+   const query = await validate(schemas.contentSearch, Object.fromEntries(searchParams));
+ 
+   // サービス呼び出し
+   const { items, total } = await contentService.searchContents(query);
+ 
+   // レスポンス
+   return NextResponse.json({
+     data: items,
+     meta: {
+       total,
+       page: query.page,
+       limit: query.limit,
+       pages: Math.ceil(total / query.limit)
+     }
+   });
+ }
+ 
+ // ミドルウェア適用（認証＋エラーハンドリング）
+ export const GET = withApiHandler(handler, { role: 'user' });
+ ```
+ 
+ ### 5.2 リポジトリパターン
+ 
+ ```typescript
+ // /lib/db/repositories/contentRepository.ts
+ import { db } from '@/lib/db/client';
+ import { Content, ContentSearchParams } from '@/types/models/content';
+ 
+ export const contentRepository = {
+   async findById(id: number): Promise<Content | null> {
+     return db.content.findUnique({
+       where: { id },
+       include: {
+         source: true,
+         tags: {
+           include: {
+             tag: true
+           }
+         }
+       }
+     });
+   },
+ 
+   async search(params: ContentSearchParams): Promise<{ items: Content[], total: number }> {
+     const { page = 1, limit = 10, status, source_id, search } = params;
+ 
+     const where = {
+       ...(status && { status }),
+       ...(source_id && { source_id: parseInt(source_id) }),
+       ...(search && {
+         OR: [
+           { title: { contains: search, mode: 'insensitive' } },
+           { content_text: { contains: search, mode: 'insensitive' } }
+         ]
+       })
+     };
+ 
+     const [items, total] = await Promise.all([
+       db.content.findMany({
+         where,
+         include: {
+           source: true,
+           tags: {
+             include: {
+               tag: true
+             }
+           }
+         },
+         skip: (page - 1) * limit,
+         take: limit,
+         orderBy: { published_at: 'desc' }
+       }),
+       db.content.count({ where })
+     ]);
+ 
+     return { items, total };
+   }
+ };
+ ```
+ 
+ ### 5.3 サービスパターン
+ 
+ ```typescript
+ // /lib/services/content/contentService.ts
+ import { contentRepository } from '@/lib/db/repositories/contentRepository';
+ import { Content, ContentSearchParams } from '@/types/models/content';
+ import { errors } from '@/lib/utils/error';
+ 
+ export const contentService = {
+   async getContentById(id: number): Promise<Content> {
+     const content = await contentRepository.findById(id);
+ 
+     if (!content) {
+       throw errors.notFound('Content not found');
+     }
+ 
+     return content;
+   },
+ 
+   async searchContents(params: ContentSearchParams): Promise<{ items: Content[], total: number }> {
+     return contentRepository.search(params);
+   }
+ };
+ ```
+ 
+ ## 6. 外部サービス連携
+ 
+ ### 6.1 SNS認証
+ 
+ - Google OAuth 2.0を利用
+ - NextAuth.jsなどのライブラリを活用して実装を簡素化
+ 
+ ### 6.2 AIサービス連携
+ 
+ - OpenAI API、Anthropic API等を利用
+ - APIキーは暗号化して保存
+ 
+ ### 6.3 通知サービス
+ 
+ - Discord Webhookを利用
+ - メール通知はSendGrid等を利用
+ 
+ ## 7. セキュリティ要件
+ 
+ ### 7.1 認証・認可
+ 
+ - JWTベースの認証
+ - ロールベースのアクセス制御（RBAC）
+ - セッションタイムアウトは24時間
+ 
+ ### 7.2 データ保護
+ 
+ - APIキーなどの機密情報は暗号化して保存
+ - パスワードはbcryptでハッシュ化
+ - 通信はHTTPS/TLSで暗号化
+ 
+ ### 7.3 プライバシーコンプライアンス
+ 
+ - 個人情報は最小限に収集
+ - 将来的にGDPR対応などが必要になった場合に拡張しやすい設計
+ 
+ ## 8. 開発・デプロイ手順
+ 
+ ### 8.1 ローカル環境のセットアップ
+ 
+ 1. リポジトリクローン
+    ```bash
+    git clone https://github.com/your-account/your-project.git
+    cd your-project
+    ```
+ 
+ 2. 依存インストール
+    ```bash
+    npm install
+    ```
+ 
+ 3. 環境変数設定
+    - `.env.local`ファイルを作成し、必要な環境変数を設定
+ 
+ 4. DBマイグレーション
+    ```bash
+    npx prisma migrate dev --name init
+    ```
+ 
+ 5. アプリ起動
+    ```bash
+    npm run dev
+    ```
+ 
+ ### 8.2 本番デプロイ方法
+ 
+ 1. Vercelへの接続
+    - GitHubリポジトリをVercelダッシュボードでImport
+    - 環境変数を設定
+ 
+ 2. Supabaseとの連携
+    - Supabaseプロジェクトを作成し、接続情報を取得
+ 
+ 3. DBマイグレーション
+    - デプロイ後、Vercelの環境でマイグレーションを実行
+ 
+ 4. Cron設定
+    - Vercel Cron Jobsを設定して定期実行
+ 
+ ## 9. 将来的な拡張
+ 
+ 1. 複雑なバックエンド: NestJSを別リポジトリで導入
+ 2. 大規模データ/負荷: Supabaseの有料プラン移行 + Redisキャッシュ
+ 3. 追加AIモデル: 複数ステップ要約の実行
+ 4. ログ・監査: Cloud Loggingなどの導入
+ 
+ ## 10. コーディング規約
+ 
+ - **ファイル名**: キャメルケース (例: `userService.ts`)
+ - **クラス/インターフェース**: パスカルケース (例: `UserService`)
+ - **関数/変数**: キャメルケース (例: `getUserById`)
+ - **定数**: 大文字スネークケース (例: `MAX_RETRY_COUNT`)
+ - 複雑なロジックには必ずコメントを付ける
+ - 必ず型定義を行い、`any`型の使用は最小限に抑える
```

---

```diff
  ### 2.2 バックエンド
  
+ - [0_Integrated_Backend_Requirements.md](./2_Functional_Requirements/backend/0_Integrated_Backend_Requirements.md) - 統合バックエンド要件定義
  - [1_Architecture_Guidelines.md](./2_Functional_Requirements/backend/1_Architecture_Guidelines.md) - アーキテクチャガイドライン
  - [2_Language_and_Framework.md](./2_Functional_Requirements/backend/2_Language_and_Framework.md) - 言語とフレームワーク
  
  - 初版作成: 2025-03-15
+ - 更新: 2025-03-16 - 統合バックエンド要件定義を追加
```

---

バックエンドとデータの要件定義を統合した新しいドキュメントを作成し、インデックスファイルも更新しました。

# 統合バックエンド要件定義の概要

バックエンドとデータの要件を統合したドキュメントを作成しました。このドキュメントは、初学者エンジニアでも実装しやすいように構成されています。主な特徴は以下の通りです：

## 主な特徴

1. **シンプルなアーキテクチャ**
   - モノリシック構成（Next.js + Supabase）で、1つのリポジトリで管理
   - 明確なレイヤー構造（UI、API、サービス、リポジトリ、ユーティリティ）

2. **技術スタックの明確化**
   - TypeScript + Next.js + Supabase という初学者にも扱いやすい組み合わせ
   - 必要なライブラリを機能別に整理

3. **データベース設計の統合**
   - ERダイアグラムによる全体像の把握
   - 主要テーブルの定義を簡潔に記載
   - データライフサイクルの方針を明確化

4. **API設計の標準化**
   - 一貫したレスポンス形式
   - 主要APIの一覧を機能別に整理

5. **実装パターンの提示**
   - APIエンドポイント、リポジトリ、サービスの実装例を提供
   - コードサンプルで具体的な実装方法を示す

6. **セキュリティと外部連携の考慮**
   - 認証・認可、データ保護の方針
   - 外部サービス（SNS認証、AI、通知）との連携方法

7. **開発・デプロイ手順の明確化**
   - ローカル環境のセットアップから本番デプロイまでのステップ
   - 将来的な拡張方針

8. **コーディング規約の提示**
   - 命名規則や型定義の方針を明確化

このドキュメントにより、初学者エンジニアでも全体像を把握しやすく、実装の指針となる情報が一箇所にまとまりました。また、将来的な拡張にも対応できる柔軟な設計となっています。

---



---

