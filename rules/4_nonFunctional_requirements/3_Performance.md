```markdown
# パフォーマンス要件 (最新版)

> **方針**
> - **お金をかけずに、経験の浅いエンジニアでも実装しやすい**技術を優先
> - **Vercel無料プラン + Supabase無料枠**でも最低限のパフォーマンスを確保できる構成
> - **将来的に拡張**（高負荷対応や追加キャッシュ導入など）しやすい設計

---

## 1. レスポンスタイム目標

1. **通常時**
   - **APIレスポンス**: 1秒以内
   - **ページ読み込み**: TTFB（Time to First Byte）を500ms以内
   - Next.js (SSR) ではサーバレス環境での初回実行（Cold Start）が発生するため、最初のリクエストで**1~2秒**程度許容（Vercel無料プランの場合）
2. **負荷時**
   - ユーザー同時アクセス数 50〜100 程度までであれば、1秒以内の応答を目指す
   - 負荷ピーク時（YouTubeなど新着大量発生時）は**2〜3秒程度**まで許容

---

## 2. スループット目標

1. **同時接続数**
   - 最初の運用では **50〜100** 同時接続を想定
   - 将来的に **1000 同時接続** へ拡張できるよう、Supabase有料プランやVercel Proへの移行を検討
2. **リクエスト数/秒 (RPS)**
   - 初期運用: **10〜20 RPS** を想定
   - ログインAPIや要約APIにアクセスが集中する場合も**30〜50 RPS**程度まで耐えられる構成を目安
   - 大幅増加が見込まれる時期があれば**レートリミット**や**有料プラン**への移行を検討

---

## 3. 負荷試験計画

1. **ツール**
   - **k6** や **Artillery** などのOSSでHTTP負荷試験
   - 簡易的には**Postman**のCollection Runnerでも可
2. **シナリオ**
   - **ログインAPI連続アクセス**: JWT発行処理のCPU負荷・DB書き込みを検証
   - **コンテンツ一覧取得**: 大量データ・ページネーションのパフォーマンス確認
   - **要約API呼び出し**: AIモデル要約処理の負荷（外部API依存だが、同時呼び出し数をチェック）
3. **テスト項目**
   - **スループット** (RPS)・**応答時間** (p95, p99)
   - **エラー率** (HTTP 5xx, タイムアウト率)
   - 1時間連続負荷 or 短期ピーク負荷 (ワークロードシミュレーション)

---

## 4. キャッシュ戦略

1. **CDN**
   - Vercel が自動で**静的ファイルをCDNキャッシュ**
   - SSG (静的生成) 可能なページは極力SSGし、CDNから配信
2. **アプリ/DBキャッシュ**
   - **Next.js** App Routerの**ISR(Incremental Static Regeneration)** で動的コンテンツを一定期間キャッシュ化
   - DBに頻繁にアクセスする箇所（タグ一覧など）は**Supabaseのキャッシュ**や**KVストア**を検討
3. **AI要約キャッシュ**
   - 同じ動画/論文への要約結果は**summaries**テーブルに保存し、再呼び出しを回避
   - Discord通知後は一定期間キャッシュして**無駄な再生成**を防ぐ

---

## 5. モニタリング指標

1. **CPU使用率 / メモリ**
   - Vercelサーバレスの場合は軽微だが、**Supabase** Postgres CPU/メモリ使用率を監視
   - DBクエリ数や慢性的な負荷をチェック
2. **レスポンスタイム**
   - p50, p95, p99 を記録 → p95 が **1秒**以内に収まることを目標
   - Vercel の [Logging/Analytics](https://vercel.com/docs/analytics) や Supabase モニタリング
3. **エラー率**
   - 5xx エラー (サーバエラー) が 1%未満
   - 4xx エラー (認証/権限/Bad Request) はリクエスト失敗ログで分析
4. **AI API呼び出し**
   - 外部AIモデルAPI のタイムアウト率, コスト計算 (トークン消費)
   - AI呼び出しが多いときのボトルネックやAPIの429エラー(レート制限)をチェック

---

### まとめ

- **1秒以内のレスポンス**を基本目標とし、YouTubeや論文の大規模データが増えた際は**キャッシュ強化**や**有料プラン**への移行
- 負荷試験には**k6/Artillery**を用い、**ログインAPI/コンテンツ取得/要約API**のボトルネックを検証
- モニタリングで**レスポンスタイム, エラー率, AI API呼び出し状況**を把握し、**サーバレス特有のCold Start**を考慮
- **小規模環境**でも最小コストで運用可能だが、拡張しやすい構成をあらかじめ確保する

以上により、初心者エンジニアが運用しつつも必要に応じて拡張できる**柔軟なパフォーマンス要件**を実現。