```markdown
# セキュリティ要件 (最新版)

> **方針**:
> - **お金をかけず、容易に**経験の浅いエンジニアでも実装できる
> - 将来的に**機能追加や大規模化**に対応しやすい構成
> - **Next.js**(バックエンド含む) + **Supabase** というシンプルな構成でも、最低限のセキュリティ水準を確保

---

## 1. アクセス制御

### 1.1 認証方式

1. **Googleアカウント認証 (OAuth2.0)**
   - **NextAuth.js**などのライブラリを用いて、Google OAuthフローを実装
   - ユーザーがGoogleログインを選択した場合、コールバックURLでアクセストークンを取得 → DBにユーザー情報を登録 → JWTを発行する流れがベストプラクティス
   - 無料で始められ、Google Developers Console からOAuthクライアントIDを取得

2. **JWT認証 (Email + パスワード)**
   - 新規ユーザー登録（サインアップ）時にメール＋パスワードをDBに保存（パスワードは**ハッシュ化**）
   - ログイン（サインイン）成功時に、JWTを発行し、**HTTP-only Cookie**など安全な手段でクライアントに返す
   - JWTには**有効期限 (例: 1日)** を付与し、長期セッションを回避
   - リフレッシュトークンや定期的な再ログインでセキュリティを強化

### 1.2 ロール/権限設計

- **admin（管理者）**
  - 監視対象（sources）CRUD、AIモデル管理、タグ管理、ユーザー管理など**すべての機能**にフルアクセス
- **user（一般ユーザー）**
  - コンテンツの閲覧、タグの追加/削除など**一般利用**が可能
  - ソース管理やAIモデル管理などの管理系操作は不可
- **guest（未ログイン）**
  - 限定的な機能のみ（例えばトップページや認証画面へのアクセス程度）
  - コンテンツ一覧の閲覧を許可するかは運用方針次第

#### 実装イメージ

- 各API Route で **JWTを検証** し、`role` を確認
  - `/api/admin/...` は `role === 'admin'` 以外は403 Forbidden
  - `/api/user/...` は `role === 'user' or 'admin'` のみ許可
  - 一般公開APIがあれば認証不要でもOK

---

## 2. 通信暗号化

### 2.1 HTTPS / TLS

- **Vercel** でホスティングする場合、**自動的にHTTPS証明書(Let's Encrypt)** が発行される
- **Supabase** との通信もTLSを利用し、アプリ側は `SUPABASE_URL (https://...)` で安全にAPI呼び出し
- 独自ドメイン設定する際も、VercelがLet's Encrypt で証明書を管理 → エンジニアは特別な設定不要

### 2.2 証明書管理

- Vercelの無料プランにおいて、SSL証明書は自動生成＆更新される
- 必要に応じて独自CA証明書を設定可能（Pro/Enterpriseプラン）だが、基本は不要

---

## 3. データ暗号化

### 3.1 保存データ（DB内）

1. **パスワード**:
   - **ハッシュ化**（bcrypt や argon2）して保存
   - **ソルト**も適切に設定し、レインボーテーブル攻撃を防止
2. **APIキー (AIモデルなど)**:
   - `ai_models.api_key_encrypted` カラムに**暗号化**または**Base64 + KMS（将来的）**
   - 復号する際はバックエンドのみ（ユーザーに表示しない）
3. **個人情報**
   - 必要最小限のみDBに保持
   - SupabaseのRow Level Security(RLS)を利用するか検討（将来）

### 3.2 Secretsの管理

- `.env.local` や **Vercel環境変数** に保管
- リポジトリには**絶対に含めない**
- Google OAuth クライアントID/Secret、JWT Secret key などは**必須で暗号化**した状態で保管

---

## 4. 脆弱性対策

### 4.1 OWASP対策

1. **SQLインジェクション**
   - ORM（Prisma/Drizzleなど）やSupabaseクライアントを使用 → プレースホルダで安全にクエリ
2. **XSS（クロスサイトスクリプティング）**
   - Next.js ではデフォルトで**Reactのエスケープ**が効く
   - 危険なHTMLを表示する際は `dangerouslySetInnerHTML` に注意
3. **CSRF（クロスサイトリクエストフォージェリ）**
   - APIを**JWT + HTTP-only Cookie**方式、または**CSRFトークン**を用いる
4. **その他**
   - 依存パッケージの自動アップデート、ESLint/Snykなどで脆弱性チェック

### 4.2 WAF/IDS/IPS

- 無料構成では**WAF未導入**が通常
- 必要に応じて**Cloudflare**などエッジサービスを導入検討
- 大規模化したら**AWS WAF**や**Vercel Proのセキュリティ機能**を検討

---

## 5. ログ・監査

### 5.1 アクセスログ / 操作ログ

1. **APIアクセスログ**
   - Vercelはデフォルトでリクエストログを保存しない → 代替としてSupabaseに**APILogテーブル**作成 or Sentry等を導入
2. **認証ログ**
   - ログイン/ログアウト時に`auth_logs`テーブルへ記録（ユーザーID, IP, timestamp等）
   - パスワード変更やリセット時もログ残す

### 5.2 保存期間・監査方法

- **保存期間**:
  - ベースは**無期限**（ストレージに問題がなければ）
  - ある程度古いログは手動削除orアーカイブ可能
- **監査方法**:
  - 管理画面でログ閲覧 or Supabaseダッシュボードでクエリ
  - 重要イベント（AIモデル設定変更など）は**Slack通知**などの拡張余地

---

## まとめ

- **HTTPS/TLS**はVercelが自動対応 → 証明書管理の手間不要
- **認証・認可**は **Google OAuth + JWT** でロールベース管理
- **DB・Secrets暗号化**を徹底し、パスワードはハッシュ化
- **OWASP対策**を最低限実施（SQLi/XSS/CSRF対策）
- **ログ収集**は Supabase or Sentry, 必要なら外部サービス連携
- 全体的に**経験の浅いエンジニアでも**無理なく導入可能で、将来的拡張も容易

これらにより、最小限のコスト・構成で**セキュリティ水準を確保**しつつ、運用負荷を低減できる見通しです。