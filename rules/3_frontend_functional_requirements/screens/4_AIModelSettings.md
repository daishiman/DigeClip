# AIモデル設定画面仕様書

## 画面概要
複数のAIモデルをシステムで使えるように管理する画面です。OpenAI、Claude、Geminiなどの各種AIサービスのAPI Keyやモデル名を設定します。デフォルトで使用するAIモデルもここで指定します。コンテンツの要約処理に使用するAIモデルの設定を一元管理することで、柔軟なAI活用を可能にします。

## 画面レイアウト
```
+----------------------------------------------------------------------+
|  DigeClip > AIモデル設定                               ユーザー名 ▼ |
+----------------------------------------------------------------------+
|                                                                      |
|  [+ 新規AIモデル追加]                                               |
|                                                                      |
|  +-------------------------------------------------------------------+
|  | AIモデル一覧                                                     |
|  +-------------------------------------------------------------------+
|  | モデル名      | サービス | デフォルト | API Key      | 操作      |
|  +--------------+-----------+------------+--------------+------------+
|  | GPT-4        | OpenAI    | ✓          | sk-***...    | 編集 削除 |
|  | Claude-3     | Anthropic |            | sk-***...    | 編集 削除 |
|  | Gemini Pro   | Google    |            | AIz***...    | 編集 削除 |
|  | ...          | ...       |            | ...          | ...       |
|  +-------------------------------------------------------------------+
|                                                                      |
|  注意: API Keyは暗号化して保存されます。セキュリティのため、         |
|  表示時は一部のみ表示しています。                                    |
|                                                                      |
+----------------------------------------------------------------------+

// モーダル: 新規AIモデル追加/編集
+--------------------------------------+
|  AIモデル追加/編集                ✕ |
+--------------------------------------+
|                                      |
|  モデル名*:                          |
|  [                             ]     |
|                                      |
|  サービス*:                          |
|  [OpenAI ▼]                          |
|                                      |
|  API Key*:                           |
|  [                             ]     |
|                                      |
|  デフォルトモデルに設定:             |
|  [ ] このモデルをデフォルトに設定    |
|                                      |
|  詳細設定:                           |
|  最大トークン数: [  4096  ]          |
|  温度: [  0.7  ]                     |
|                                      |
|  [キャンセル]        [保存]          |
|                                      |
+--------------------------------------+
```

## 機能要件
1. **AIモデル一覧表示**
   - テーブル形式で表示
   - カラム: モデル名、サービス、デフォルト設定、API Key（一部マスク）、操作
   - デフォルト設定されたモデルは視覚的に強調表示

2. **新規AIモデル追加**
   - 「新規AIモデル追加」ボタンでモーダル表示
   - 必須項目: モデル名、サービス、API Key
   - オプション: デフォルト設定、詳細パラメータ

3. **AIモデル編集**
   - 既存モデルの「編集」ボタンでモーダル表示
   - 現在の値をフォームに初期表示（API Keyは再入力必要）
   - すべての項目を編集可能

4. **AIモデル削除**
   - 削除前に確認ダイアログを表示
   - デフォルトモデルの削除時は警告表示

5. **デフォルトモデル設定**
   - チェックボックスでデフォルト設定
   - 新たにデフォルト設定すると、既存のデフォルトは解除

6. **詳細パラメータ設定**
   - モデルごとのパラメータ設定（トークン数、温度など）
   - サービスタイプに応じて表示項目を変更

## バリデーション要件
1. **モデル名**
   - 必須入力
   - 最大50文字
   - 重複チェック（同一名称は不可）

2. **サービス**
   - 必須選択
   - 選択肢: "OpenAI", "Anthropic", "Google", "その他"

3. **API Key**
   - 必須入力
   - サービスごとの形式チェック
     - OpenAI: "sk-" で始まる
     - Anthropic: "sk-ant-" で始まる
     - Google: 適切な長さと形式
   - 最小長: 10文字

4. **詳細パラメータ**
   - 最大トークン数: 1～32000の整数
   - 温度: 0～2の小数（0.1刻み）

## エラーメッセージ
- 入力検証エラー:
  - 「モデル名を入力してください」
  - 「モデル名は50文字以内で入力してください」
  - 「同じ名前のモデルが既に存在します」
  - 「API Keyを入力してください」
  - 「API Keyの形式が正しくありません」
  - 「最大トークン数は1～32000の整数で入力してください」
  - 「温度は0～2の範囲で入力してください」

- 操作エラー:
  - 「モデルの追加に失敗しました」
  - 「モデルの更新に失敗しました」
  - 「モデルの削除に失敗しました」
  - 「デフォルト設定の変更に失敗しました」
  - 「API Keyの検証に失敗しました」

## API連携
1. **AIモデル一覧取得API**
   - エンドポイント: `/api/ai-models`
   - メソッド: GET
   - レスポンス:
     ```json
     {
       "data": [
         {
           "id": 1,
           "name": "GPT-4",
           "service": "openai",
           "apiKeyMasked": "sk-***...",
           "isDefault": true,
           "parameters": {
             "maxTokens": 4096,
             "temperature": 0.7
           },
           "createdAt": "2023-03-10T14:30:00Z",
           "updatedAt": "2023-03-15T09:45:00Z"
         },
         // ...
       ]
     }
     ```

2. **AIモデル追加API**
   - エンドポイント: `/api/ai-models`
   - メソッド: POST
   - リクエストボディ:
     ```json
     {
       "name": "Claude-3",
       "service": "anthropic",
       "apiKey": "sk-ant-...",
       "isDefault": false,
       "parameters": {
         "maxTokens": 8192,
         "temperature": 0.8
       }
     }
     ```
   - レスポンス: 作成されたモデルオブジェクト（APIキーはマスク）

3. **AIモデル更新API**
   - エンドポイント: `/api/ai-models/[id]`
   - メソッド: PUT
   - リクエストボディ: 更新するフィールド
   - レスポンス: 更新されたモデルオブジェクト

4. **AIモデル削除API**
   - エンドポイント: `/api/ai-models/[id]`
   - メソッド: DELETE
   - レスポンス: 成功時は204 No Content

5. **デフォルト設定API**
   - エンドポイント: `/api/ai-models/[id]/default`
   - メソッド: PATCH
   - リクエストボディ: `{ "isDefault": true }`
   - レスポンス: 更新されたモデルオブジェクト

6. **API Key検証API**（オプション）
   - エンドポイント: `/api/ai-models/verify-key`
   - メソッド: POST
   - リクエストボディ: `{ "service": "openai", "apiKey": "sk-..." }`
   - レスポンス: `{ "valid": true/false, "message": "..." }`

## UI/UX考慮事項
1. **セキュリティ表示**
   - API Keyは常に一部マスク表示（例: "sk-***..."）
   - 編集時はAPI Keyを再入力させる
   - セキュリティに関する注意書きを表示

2. **デフォルト表示**
   - デフォルトモデルは視覚的に強調（アイコンや色で区別）
   - デフォルト変更時は即時反映

3. **モーダルフォーム**
   - サービス選択に応じてフォーム項目を動的変更
   - 詳細設定は折りたたみ可能に
   - 入力中のリアルタイムバリデーション

4. **フィードバック**
   - 操作成功時は通知メッセージを表示
   - API Key検証中はローディングインジケータを表示

5. **アクセシビリティ**
   - キーボード操作のサポート
   - スクリーンリーダー対応
   - 適切なラベルとARIA属性の使用

## 実装上の注意事項
1. **セキュリティ対策**
   - API Keyは暗号化して保存
   - フロントエンドでのAPI Key表示は最小限に
   - バックエンドでのみ完全なAPI Keyにアクセス可能に

2. **フォーム処理**
   - フォーム状態管理にはReact Hook Form等のライブラリ活用
   - 送信前にクライアント側でバリデーション
   - 送信中はボタンを無効化

3. **デフォルト設定の処理**
   - デフォルト変更時は他のモデルのデフォルト設定を解除
   - 最低1つのデフォルトモデルが存在するよう保証
   - デフォルトモデル削除時は別モデルを自動的にデフォルトに設定

4. **エラーハンドリング**
   - API通信エラーの適切な処理
   - ユーザーフレンドリーなエラーメッセージ表示
   - API Key検証失敗時の詳細なフィードバック

5. **パラメータ設定**
   - サービスごとに適切なパラメータ範囲を設定
   - 推奨値をプレースホルダーで表示
   - 詳細な説明をツールチップで提供

6. **テスト**
   - 各CRUD操作のユニットテスト
   - API Key検証のテスト
   - エラー状態のテスト