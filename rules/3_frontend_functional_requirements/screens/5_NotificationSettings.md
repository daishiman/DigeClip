# 通知設定画面仕様書

## 画面概要
Discordへの通知方法を管理する画面です。Webhook URLを登録し、Embed形式のテンプレートを編集できます。必要に応じてテスト送信を行い、設定の正しさを確認します。コンテンツの要約結果をDiscordに通知する際の見た目や内容をカスタマイズすることで、効果的な情報共有を実現します。

## 画面レイアウト
```
+----------------------------------------------------------------------+
|  DigeClip > 通知設定                                   ユーザー名 ▼ |
+----------------------------------------------------------------------+
|                                                                      |
|  Discord Webhook設定                                                |
|  +-------------------------------------------------------------------+
|  | Webhook URL*:                                                    |
|  | [https://discord.com/api/webhooks/123456789/abcdef...         ] |
|  |                                                                  |
|  | [Discord Webhookの作成方法を見る]                                |
|  +-------------------------------------------------------------------+
|                                                                      |
|  Embedテンプレート設定                                              |
|  +-------------------------------------------------------------------+
|  | タイトル形式*:                                                   |
|  | [{{title}} - DigeClip要約                                      ] |
|  |                                                                  |
|  | 説明文形式*:                                                     |
|  | [                                                               ] |
|  | [{{summary}}                                                    ] |
|  | [                                                               ] |
|  |                                                                  |
|  | サムネイルURL:                                                   |
|  | [{{thumbnail}}                                                  ] |
|  |                                                                  |
|  | フッターテキスト:                                                |
|  | [元URL: {{url}}                                                ] |
|  |                                                                  |
|  | Embedカラー:                                                     |
|  | [#3498db ▼]                                                      |
|  +-------------------------------------------------------------------+
|                                                                      |
|  プレビュー                                                         |
|  +-------------------------------------------------------------------+
|  |                                                                  |
|  | +--------------------------------------------------------------+ |
|  | | タイトル例: AI技術の最新動向 - DigeClip要約                  | |
|  | |                                                              | |
|  | | 説明文例: 本動画では、2025年のAI業界における3つの重要な...   | |
|  | |                                                              | |
|  | | 元URL: https://youtube.com/watch?v=example                   | |
|  | +--------------------------------------------------------------+ |
|  |                                                                  |
|  +-------------------------------------------------------------------+
|                                                                      |
|  [テスト送信]                                          [保存]        |
|                                                                      |
+----------------------------------------------------------------------+
```

## 機能要件
1. **Discord Webhook設定**
   - Webhook URL入力欄
   - Discord Webhook作成方法へのリンク

2. **Embedテンプレート設定**
   - タイトル形式: 通知タイトルのテンプレート
   - 説明文形式: 通知本文のテンプレート（複数行）
   - サムネイルURL: サムネイル画像のURL
   - フッターテキスト: Embed下部に表示するテキスト
   - Embedカラー: サイドバーの色指定

3. **テンプレート変数**
   - `{{title}}`: コンテンツのタイトル
   - `{{summary}}`: 要約テキスト
   - `{{thumbnail}}`: サムネイル画像URL
   - `{{url}}`: 元コンテンツのURL
   - `{{published_at}}`: 公開日時
   - `{{source}}`: ソース名（YouTubeチャンネル名など）

4. **プレビュー表示**
   - 現在の設定に基づくEmbed表示のプレビュー
   - サンプルデータを使用して表示

5. **テスト送信機能**
   - 「テスト送信」ボタンで実際にDiscordに送信
   - 送信結果のフィードバック表示

6. **設定保存**
   - 「保存」ボタンで設定を保存
   - 保存成功/失敗のフィードバック表示

## バリデーション要件
1. **Webhook URL**
   - 必須入力
   - Discord Webhook URL形式（https://discord.com/api/webhooks/...）
   - 最大長: 200文字

2. **タイトル形式**
   - 必須入力
   - 最大長: 256文字（Discordの制限）
   - 少なくとも1つのテンプレート変数を含む

3. **説明文形式**
   - 必須入力
   - 最大長: 4000文字（Discordの制限）
   - 少なくとも1つのテンプレート変数を含む

4. **サムネイルURL**
   - オプション
   - 有効なURL形式
   - 画像ファイル形式（.jpg, .png, .gif, .webp）

5. **フッターテキスト**
   - オプション
   - 最大長: 2048文字（Discordの制限）

6. **Embedカラー**
   - オプション
   - 有効なHEX色コード（#RRGGBB）

## エラーメッセージ
- 入力検証エラー:
  - 「Webhook URLを入力してください」
  - 「有効なDiscord Webhook URLを入力してください」
  - 「タイトル形式を入力してください」
  - 「タイトル形式は256文字以内で入力してください」
  - 「説明文形式を入力してください」
  - 「説明文形式は4000文字以内で入力してください」
  - 「有効なURL形式で入力してください」（サムネイルURL）
  - 「有効な色コードを入力してください」（Embedカラー）

- 操作エラー:
  - 「設定の保存に失敗しました」
  - 「テスト送信に失敗しました」
  - 「Webhook URLが無効です。Discord設定を確認してください」
  - 「Discordサーバーへの接続に失敗しました」

## API連携
1. **通知設定取得API**
   - エンドポイント: `/api/notification-settings`
   - メソッド: GET
   - レスポンス:
     ```json
     {
       "webhookUrl": "https://discord.com/api/webhooks/123456789/abcdef...",
       "embedTemplate": {
         "titleFormat": "{{title}} - DigeClip要約",
         "descriptionFormat": "{{summary}}",
         "thumbnailUrl": "{{thumbnail}}",
         "footerText": "元URL: {{url}}",
         "color": "#3498db"
       },
       "updatedAt": "2023-03-15T09:45:00Z"
     }
     ```

2. **通知設定更新API**
   - エンドポイント: `/api/notification-settings`
   - メソッド: PUT
   - リクエストボディ:
     ```json
     {
       "webhookUrl": "https://discord.com/api/webhooks/123456789/abcdef...",
       "embedTemplate": {
         "titleFormat": "{{title}} - DigeClip要約",
         "descriptionFormat": "{{summary}}",
         "thumbnailUrl": "{{thumbnail}}",
         "footerText": "元URL: {{url}}",
         "color": "#3498db"
       }
     }
     ```
   - レスポンス: 更新された設定オブジェクト

3. **テスト送信API**
   - エンドポイント: `/api/notification-settings/test`
   - メソッド: POST
   - リクエストボディ:
     ```json
     {
       "webhookUrl": "https://discord.com/api/webhooks/123456789/abcdef...",
       "embedTemplate": {
         "titleFormat": "{{title}} - DigeClip要約",
         "descriptionFormat": "{{summary}}",
         "thumbnailUrl": "{{thumbnail}}",
         "footerText": "元URL: {{url}}",
         "color": "#3498db"
       }
     }
     ```
   - レスポンス:
     ```json
     {
       "success": true,
       "message": "テスト通知が正常に送信されました"
     }
     ```

## UI/UX考慮事項
1. **テンプレート変数のヘルプ**
   - 各入力欄の近くに使用可能な変数の説明
   - 変数挿入ボタンまたはドロップダウン

2. **リアルタイムプレビュー**
   - 入力内容変更時にプレビューを自動更新
   - プレビューはDiscordの表示に近い見た目で

3. **フォームレイアウト**
   - 論理的なグループ分け
   - 必須項目の明確な表示（アスタリスク等）
   - 十分な入力スペース（特に説明文）

4. **フィードバック**
   - テスト送信結果を明確に表示
   - 保存成功時の通知
   - エラー時の具体的なガイダンス

5. **アクセシビリティ**
   - キーボード操作のサポート
   - スクリーンリーダー対応
   - 適切なコントラスト比

## 実装上の注意事項
1. **セキュリティ対策**
   - Webhook URLは暗号化して保存
   - XSS対策（入力値のサニタイズ）
   - CSRF対策

2. **テンプレート処理**
   - テンプレート変数の置換処理を適切に実装
   - 変数が存在しない場合の適切なフォールバック
   - 長いテキストの自動トリミング（Discord制限内に）

3. **Discord API連携**
   - Discord Webhook APIの仕様に準拠
   - レート制限への対応
   - エラーレスポンスの適切な解析と表示

4. **フォーム処理**
   - フォーム状態管理にはReact Hook Form等のライブラリ活用
   - 送信前にクライアント側でバリデーション
   - 送信中はボタンを無効化

5. **エラーハンドリング**
   - ネットワークエラーの適切な処理
   - Discord側のエラーコードに応じた対応
   - ユーザーフレンドリーなエラーメッセージ

6. **テスト**
   - 各フォーム項目のバリデーションテスト
   - テンプレート変数置換のテスト
   - Discord API連携のモックテスト