# Google OAuth ログイン API

- **HTTPメソッド**: `GET`
- **エンドポイント**: `/api/auth/google-callback`
- **機能概要**: Google OAuth 2.0 コールバックを受け取り、成功ならJWT発行
- **認証要否**: **不要**(guest)

## リクエスト

**Request**:
- クエリに `code` 等含む (Google OAuth からリダイレクトパラメータ)

```ts
export interface IAuthGoogleCallbackQuery {
  code: string;     // Google OAuth code
  state?: string;   // CSRF対策など
}
```

**例 (GoogleからのリダイレクトURL)**
```
GET /api/auth/google-callback?code=4/0AX4XfW...
```

## レスポンス

**Response**: `IAuthGoogleCallbackResponse`
```ts
export interface IAuthGoogleCallbackResponse {
  userId: number;
  role: "user" | "admin";
  token: string;       // JWT
  expiresIn: number;   // 有効期限 (秒)
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "userId": 567,
  "role": "user",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI...",
  "expiresIn": 3600
}
```

## エラー

**Error**: e.g. `401 Unauthorized` (Google認証失敗)
```jsonc
{
  "error": {
    "code": "E4012",
    "message": "Google OAuth failed or was canceled"
  }
}
```

## 実装上の注意事項

1. **OAuth設定**:
   - Google Cloud Consoleで適切なOAuthクライアントIDとシークレットを設定してください。
   - 承認済みのリダイレクトURIに、このコールバックエンドポイントのURLを登録してください。
   - 必要なスコープ（最低限 `email` と `profile`）を設定してください。

2. **クエリパラメータの検証**:
   - `code` パラメータが存在し、空でないことを確認してください。
   - `state` パラメータが使用されている場合、セッションに保存された値と一致することを確認してください（CSRF対策）。
   - パラメータが無効な場合は、適切なエラーメッセージと共に `400 Bad Request` を返してください。

3. **認証コードの交換**:
   - 受け取った `code` を使用して、Google OAuth APIにアクセストークンをリクエストしてください。
   - このリクエストには、クライアントID、クライアントシークレット、リダイレクトURI、認証コードを含めてください。
   - アクセストークンの取得に失敗した場合は、`401 Unauthorized` エラーを返してください。

4. **ユーザー情報の取得**:
   - 取得したアクセストークンを使用して、Google APIからユーザー情報（メールアドレス、名前など）を取得してください。
   - ユーザー情報の取得に失敗した場合は、`401 Unauthorized` エラーを返してください。

5. **ユーザーアカウントの処理**:
   - 取得したメールアドレスに対応するユーザーがデータベースに存在するか確認してください。
   - 存在する場合は、そのユーザーアカウントを使用してログイン処理を行ってください。
   - 存在しない場合は、新しいユーザーアカウントを作成してください（自動登録）。
   - 新規ユーザー作成時は、Google APIから取得した情報（名前、プロフィール画像URLなど）を使用してプロフィールを初期化してください。

6. **JWTの生成**:
   - セキュアな秘密鍵を使用してJWTを生成してください。
   - JWTには少なくとも以下の情報を含めてください:
     - ユーザーID
     - ユーザーロール
     - 発行時刻（iat）
     - 有効期限（exp）
     - 認証方法（例：`auth_provider: "google"`）
   - 有効期限は適切に設定してください（例：1時間）。

7. **セッション管理（オプション）**:
   - リフレッシュトークンを使用する場合、Googleから取得したリフレッシュトークンを安全に保存してください。
   - これにより、ユーザーが再度ログインしなくても、アクセストークンを更新できます。

8. **エラーハンドリング**:
   - Google APIとの通信エラーを適切に処理してください。
   - ネットワークエラー、タイムアウト、APIレート制限などの一時的な問題に対しては、リトライロジックの実装を検討してください。
   - 永続的なエラー（無効なクライアントIDなど）は、詳細なエラーログを記録し、適切なエラーメッセージを返してください。

9. **リダイレクト処理**:
   - このAPIは通常、フロントエンドアプリケーションへのリダイレクトを伴います。
   - 認証成功時は、JWTを含むURLにリダイレクトしてください（例：`https://example.com/auth/callback?token=...`）。
   - 認証失敗時は、エラー情報を含むURLにリダイレクトしてください（例：`https://example.com/auth/callback?error=...`）。
   - セキュリティ上の理由から、JWTをURLパラメータとして渡す代わりに、一時的なコードを発行し、そのコードをフロントエンドが別のAPIエンドポイントで交換する方式も検討してください。

10. **ログ記録**:
    - 認証イベントを記録してください。
    - ログには少なくとも、タイムスタンプ、IPアドレス、ユーザーエージェント、認証結果（成功/失敗）、ユーザーID（成功時）を含めてください。
    - 個人情報保護のため、ログにトークンやユーザーの詳細情報を記録しないでください。

11. **セキュリティ考慮事項**:
    - `state` パラメータを使用してCSRF攻撃を防止してください。
    - OAuth認証フローを開始する前に、ランダムな値を生成し、セッションに保存してください。
    - コールバック時に、クエリパラメータの `state` とセッションの値を比較してください。

12. **エラーレスポンス**:
    - ユーザーフレンドリーなエラーメッセージを返してください。
    - 技術的な詳細はログに記録し、ユーザーには一般的なメッセージを表示してください。
    - 特に、Google APIからのエラーレスポンスをそのまま転送しないでください。