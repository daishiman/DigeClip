# パスワード変更 API

- **HTTPメソッド**: `POST`
- **エンドポイント**: `/api/auth/change-password`
- **機能概要**: ログイン中ユーザーがパスワードを変更
- **認証要否**: **要**(user/admin)

## リクエスト

**Request**: `IAuthChangePasswordRequest`
```ts
export interface IAuthChangePasswordRequest {
  currentPassword: string;
  newPassword: string;
}
```

**例 (リクエストJSON)**
```jsonc
{
  "currentPassword": "MySecret123",
  "newPassword": "NewSecret456"
}
```

## レスポンス

**Response**: `IAuthChangePasswordResponse`
```ts
export interface IAuthChangePasswordResponse {
  message: string;
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "message": "Password changed successfully"
}
```

## エラー

**Error**: e.g. `401 Unauthorized` (currentPassword が違う)
```jsonc
{
  "error": {
    "code": "E4014",
    "message": "Current password is incorrect"
  }
}
```

## 実装上の注意事項

1. **認証・認可**:
   - リクエスト処理前に必ず認証トークンを検証してください。
   - 無効なトークンや期限切れのトークンの場合は、`401 Unauthorized` エラーを返してください。
   - 認証されたユーザーのIDを取得し、そのユーザーのパスワードのみを変更できるようにしてください。

2. **入力検証**:
   - `currentPassword` と `newPassword` フィールドが空でないことを確認してください。
   - `newPassword` がパスワード強度の要件を満たしていることを確認してください（例：最小8文字、大文字・小文字・数字を含むなど）。
   - `currentPassword` と `newPassword` が同じでないことを確認してください（変更の意味がない）。
   - 入力が無効な場合は、適切なエラーメッセージと共に `400 Bad Request` を返してください。

3. **現在のパスワード検証**:
   - データベースから取得したユーザーの現在のパスワードハッシュと、入力された `currentPassword` を安全に比較してください。
   - パスワードハッシュの比較には、タイミング攻撃を防ぐため、定数時間比較を使用してください。
   - 現在のパスワードが一致しない場合は、`401 Unauthorized` エラーを返してください。

4. **パスワード履歴チェック（オプション）**:
   - セキュリティポリシーに応じて、過去に使用したパスワードの再利用を禁止することを検討してください。
   - パスワード履歴を保存している場合、新しいパスワードが過去のパスワードと一致しないことを確認してください。
   - 履歴と一致する場合は、適切なエラーメッセージと共に `400 Bad Request` を返してください。

5. **パスワードハッシュ化**:
   - 新しいパスワードは平文で保存せず、必ず強力なハッシュアルゴリズム（bcrypt, Argon2など）を使用してハッシュ化してください。
   - 適切なソルトを使用し、十分な計算コスト（ワークファクター）を設定してください。
   - ハッシュ化されたパスワードとソルトをデータベースに保存してください。

6. **データベース更新**:
   - ユーザーのパスワードハッシュを新しい値で更新してください。
   - `updated_at` フィールドを現在のUTC時刻に更新してください。
   - 更新操作はトランザクション内で実行し、エラー時にはロールバックしてください。

7. **セッション管理（オプション）**:
   - セキュリティポリシーに応じて、パスワード変更後に以下のいずれかの処理を検討してください:
     - 現在のセッションを維持（デフォルト）
     - 現在のセッションを除くすべてのセッションを無効化
     - すべてのセッションを無効化し、再ログインを要求
   - セッションを無効化する場合、関連するトークンをブラックリストに追加するか、データベースから削除してください。

8. **ログ記録**:
   - パスワード変更イベントを記録してください。
   - ログには少なくとも、タイムスタンプ、ユーザーID、IPアドレス、ユーザーエージェントを含めてください。
   - 個人情報保護のため、ログにパスワード（現在のものも新しいものも）を記録しないでください。

9. **通知**:
   - パスワードが正常に変更された後、確認メールをユーザーに送信することを検討してください。
   - これにより、ユーザーは不正なパスワード変更に気付くことができます。

10. **レート制限**:
    - 短時間に多数のパスワード変更リクエストを送信する攻撃を防ぐため、レート制限の実装を検討してください。
    - 制限に達した場合は、`429 Too Many Requests` エラーを返してください。

11. **エラーハンドリング**:
    - データベース接続エラーなどの内部エラーは `500 Internal Server Error` として処理し、詳細なエラーログを記録してください。
    - エラーメッセージにはセキュリティ上の機密情報を含めないよう注意してください。

12. **セキュリティヘッダー**:
    - レスポンスに適切なセキュリティヘッダーを含めてください:
      - `Cache-Control: no-store`
      - `Pragma: no-cache`
      - `X-Content-Type-Options: nosniff`