# ユーザー登録 API

- **HTTPメソッド**: `POST`
- **エンドポイント**: `/api/auth/register`
- **機能概要**: 新規ユーザーを登録し、JWT発行(自動ログイン)する
- **認証要否**: **不要**(guest)

## リクエスト

**Request**: `IAuthRegisterRequest`
```ts
export interface IAuthRegisterRequest {
  email: string;
  password: string;
  name?: string; // 任意ユーザー名
}
```

**例 (リクエストJSON)**
```jsonc
{
  "email": "john@example.com",
  "password": "MySecret123",
  "name": "John Smith"
}
```

## レスポンス

**Response**: `IAuthRegisterResponse`
```ts
export interface IAuthRegisterResponse {
  userId: number;
  role: "user" | "admin";
  token: string;           // JWT
  expiresIn: number;       // 有効期限 (秒)
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "userId": 123,
  "role": "user",
  "token": "eyJhbGciOiJIUz...",
  "expiresIn": 3600
}
```

## エラー

**Error**: e.g. `409 Conflict` (既にメールが登録済み)
```jsonc
{
  "error": {
    "code": "E4091",
    "message": "Email already in use"
  }
}
```

## 実装上の注意事項

1. **入力検証**:
   - `email` フィールドが有効なメールアドレス形式であることを確認してください。
   - `password` フィールドが空でないことと、パスワード強度の要件を満たしていることを確認してください（例：最小8文字、大文字・小文字・数字を含むなど）。
   - `name` フィールドが指定された場合、長さ制限（例：最大50文字）や禁止文字（例：制御文字）をチェックしてください。
   - 入力が無効な場合は、適切なエラーメッセージと共に `400 Bad Request` を返してください。

2. **重複チェック**:
   - 同じ `email` を持つユーザーが既に存在しないか確認してください。
   - 大文字・小文字を区別しない比較を行うことを推奨します（例：`LOWER(email) = LOWER(?)`）。
   - 重複がある場合は `409 Conflict` エラーを返してください。

3. **パスワードハッシュ化**:
   - パスワードは平文で保存せず、必ず強力なハッシュアルゴリズム（bcrypt, Argon2など）を使用してハッシュ化してください。
   - 適切なソルトを使用し、十分な計算コスト（ワークファクター）を設定してください。
   - ハッシュ化されたパスワードとソルトをデータベースに保存してください。

4. **ユーザーロールの設定**:
   - 新規ユーザーには通常 "user" ロールを割り当ててください。
   - "admin" ロールは特別な方法（例：既存の管理者による招待）でのみ割り当てるようにしてください。

5. **メール確認（オプション）**:
   - メール確認が必要なシステムの場合、ユーザーアカウントを「未確認」状態で作成し、確認メールを送信してください。
   - 確認トークンを生成し、安全に保存してください。
   - 確認メールには、確認用のリンクとトークンを含めてください。

6. **JWTの生成**:
   - セキュアな秘密鍵を使用してJWTを生成してください。
   - JWTには少なくとも以下の情報を含めてください:
     - ユーザーID
     - ユーザーロール
     - 発行時刻（iat）
     - 有効期限（exp）
   - 有効期限は適切に設定してください（例：1時間）。
   - メール確認が必要なシステムの場合、JWT内にメール確認状態を含めることを検討してください。

7. **データベース操作**:
   - ユーザー情報の挿入操作はトランザクション内で実行し、エラー時にはロールバックしてください。
   - `created_at` と `updated_at` フィールドには現在のUTC時刻を設定してください。

8. **ログ記録**:
   - 新規ユーザー登録を記録してください。
   - ログには少なくとも、タイムスタンプ、IPアドレス、ユーザーエージェント、登録されたメールアドレス（個人情報保護に注意）を含めてください。
   - 個人情報保護のため、ログにパスワードを記録しないでください。

9. **セキュリティヘッダー**:
   - レスポンスに適切なセキュリティヘッダーを含めてください:
     - `Cache-Control: no-store`
     - `Pragma: no-cache`
     - `X-Content-Type-Options: nosniff`

10. **スパム対策**:
    - 同一IPアドレスからの連続登録試行を制限することを検討してください。
    - 必要に応じて、CAPTCHA や reCAPTCHA などの追加の検証を実装してください。

11. **プロフィール初期化**:
    - ユーザープロフィールの初期設定を行ってください（例：デフォルトのプロフィール画像、表示設定など）。
    - 必要に応じて、ユーザー固有の初期データを作成してください（例：デフォルトのコレクションなど）。

12. **エラーハンドリング**:
    - データベース接続エラーなどの内部エラーは `500 Internal Server Error` として処理し、詳細なエラーログを記録してください。
    - エラーメッセージにはセキュリティ上の機密情報を含めないよう注意してください。

13. **GDPR対応（該当する場合）**:
    - ユーザーの同意を得て、プライバシーポリシーへの同意記録を保存してください。
    - データ処理の目的と保持期間を明確にしてください。