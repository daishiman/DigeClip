# ログアウト API

- **HTTPメソッド**: `POST`
- **エンドポイント**: `/api/auth/logout`
- **機能概要**: セッション無効化/JWTブラックリスト化 or Cookie削除
- **認証要否**: **要**(user/admin)

## リクエスト

**Request**: `IAuthLogoutRequest`
```ts
export interface IAuthLogoutRequest {
  // 特になし(リクエストボディ不要でも可)
}
```
**例 (リクエストJSON)**
```jsonc
{}
```

## レスポンス

**Response**: `IAuthLogoutResponse`
```ts
export interface IAuthLogoutResponse {
  message: string;
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "message": "Logged out successfully"
}
```

## エラー

**Error**: e.g. `401 Unauthorized` (トークン無効)
```jsonc
{
  "error": {
    "code": "E4013",
    "message": "Invalid or expired token"
  }
}
```

## 実装上の注意事項

1. **認証・認可**:
   - リクエスト処理前に必ず認証トークンを検証してください。
   - 無効なトークンや期限切れのトークンの場合は、`401 Unauthorized` エラーを返してください。

2. **トークン無効化**:
   - JWT認証を使用している場合、以下のいずれかの方法でトークンを無効化してください:
     - トークンをブラックリストに追加（Redis等のキャッシュを使用）
     - トークンの有効期限を現在時刻に更新（データベースにトークン情報を保存している場合）
   - ブラックリストに追加する場合、元のトークンの有効期限までブラックリスト情報を保持してください。

3. **セッション管理**:
   - セッションベースの認証を使用している場合、ユーザーのセッションを無効化してください。
   - セッションストアからセッション情報を削除してください。
   - セッションCookieが使用されている場合、Cookieを削除するようにレスポンスヘッダーを設定してください。

4. **リフレッシュトークン処理**:
   - リフレッシュトークンを使用している場合、関連するリフレッシュトークンも無効化してください。
   - データベースからリフレッシュトークンを削除するか、無効フラグを設定してください。

5. **複数デバイス対応**:
   - 複数デバイスでのログインをサポートしている場合、以下のいずれかの方法を検討してください:
     - 現在のデバイスのみからログアウト（デフォルト）
     - すべてのデバイスからログアウト（オプションパラメータで指定）
   - すべてのデバイスからログアウトする場合、ユーザーに関連するすべてのトークンを無効化してください。

6. **ログ記録**:
   - ログアウトイベントを記録してください。
   - ログには少なくとも、タイムスタンプ、ユーザーID、IPアドレス、ユーザーエージェントを含めてください。

7. **レスポンスヘッダー**:
   - レスポンスに適切なセキュリティヘッダーを含めてください:
     - `Cache-Control: no-store`
     - `Pragma: no-cache`
   - Cookie認証を使用している場合、認証Cookieを削除するための `Set-Cookie` ヘッダーを設定してください。

8. **クライアント側の処理**:
   - クライアント側でもローカルストレージやセッションストレージからトークンを削除するよう指示してください。
   - これはAPIの実装ではなくクライアント側の責任ですが、ドキュメントに記載しておくと良いでしょう。

9. **エラーハンドリング**:
   - トークンブラックリストへの追加やセッション削除に失敗した場合でも、クライアントにはエラーを返さず、成功レスポンスを返すことを検討してください。
   - 内部エラーはログに記録し、必要に応じて監視システムに通知してください。

10. **レート制限**:
    - 短時間に多数のログアウトリクエストを送信する攻撃を防ぐため、レート制限の実装を検討してください。
    - 制限に達した場合は、`429 Too Many Requests` エラーを返してください。