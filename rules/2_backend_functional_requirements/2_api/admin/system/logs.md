# システムログ取得 API

- **HTTPメソッド**: `GET`
- **エンドポイント**: `/api/admin/system/logs`
- **機能概要**: システムログを取得
- **認証要否**: **要**(admin)

## リクエスト

**Query Parameters**:
- `level`: ログレベル（"error", "warn", "info", "debug"）、デフォルトは "error"
- `start_date`: 開始日時（ISO 8601形式）
- `end_date`: 終了日時（ISO 8601形式）、デフォルトは現在時刻
- `component`: コンポーネント名でフィルタリング（例: "database", "auth", "ai"）
- `search`: ログメッセージ内の検索キーワード
- `page`: ページ番号（1から開始）、デフォルトは1
- `per_page`: 1ページあたりの件数、デフォルトは50、最大100

## レスポンス

**Response**: `IAdminGetSystemLogsResponse`
```ts
export interface IAdminGetSystemLogsResponse {
  logs: {
    id: string;
    timestamp: string;
    level: "error" | "warn" | "info" | "debug";
    component: string;
    message: string;
    details?: any;
    request_id?: string;
    user_id?: number;
  }[];
  pagination: {
    total: number;
    page: number;
    per_page: number;
    total_pages: number;
  };
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "logs": [
    {
      "id": "log_12345",
      "timestamp": "2025-03-15T14:22:15Z",
      "level": "error",
      "component": "ai_service",
      "message": "AI model connection timeout",
      "details": {
        "model_id": 2,
        "model_name": "Claude 3 Opus",
        "timeout_ms": 30000,
        "request_payload_size": 15240
      },
      "request_id": "req_abcdef123456",
      "user_id": 42
    },
    {
      "id": "log_12344",
      "timestamp": "2025-03-15T14:20:05Z",
      "level": "error",
      "component": "database",
      "message": "Database query failed",
      "details": {
        "query_type": "SELECT",
        "table": "contents",
        "error_code": "23505"
      },
      "request_id": "req_abcdef123455"
    }
  ],
  "pagination": {
    "total": 128,
    "page": 1,
    "per_page": 50,
    "total_pages": 3
  }
}
```

## エラー

**Error**: e.g. `400 Bad Request`
```jsonc
{
  "error": {
    "code": "E4001",
    "message": "Invalid query parameters",
    "details": {
      "level": "Unknown log level: 'critical'"
    }
  }
}
```

## 実装上の注意事項

1. **認証・認可**:
   - 管理者権限を持つユーザーのみアクセス可能なエンドポイントです。
   - リクエスト処理前に必ず認証トークンを検証し、管理者権限を確認してください。
   - ログには機密情報が含まれる可能性があるため、認可チェックは厳格に行ってください。

2. **クエリパラメータの検証**:
   - `level` パラメータが指定された場合、有効な値（"error", "warn", "info", "debug"）であることを確認してください。
   - 日付パラメータ（`start_date`, `end_date`）が指定された場合、有効なISO 8601形式であることを確認してください。
   - `end_date` が `start_date` より後の日時であることを確認してください。
   - `page` と `per_page` は正の整数であることを確認してください。
   - `per_page` の最大値（100）を超えないようにしてください。

3. **日付範囲の制限**:
   - パフォーマンスとセキュリティの観点から、取得可能なログの日付範囲に制限を設けることを検討してください（例：最大30日間）。
   - 日付範囲が指定されていない場合のデフォルト範囲を設定してください（例：過去24時間）。

4. **ログストレージの考慮**:
   - ログの保存方法に応じて、適切なクエリを実装してください:
     - データベース（RDB）に保存している場合: SQLクエリでフィルタリングと検索を実装
     - 専用のログサービス（CloudWatch, Datadog等）を使用している場合: そのサービスのAPIを使用
     - ファイルシステムに保存している場合: ファイル読み込みとパース処理を実装
   - 大量のログデータがある場合、インデックスの活用やクエリの最適化を検討してください。

5. **機密情報の取り扱い**:
   - ログ内の機密情報（パスワード、トークン、個人情報など）は適切にマスクまたは除外してください。
   - `details` フィールドには機密情報が含まれないように注意してください。
   - 必要に応じて、ログデータを返す前に追加のフィルタリングを実装してください。

6. **パフォーマンス最適化**:
   - ログデータは大量になる可能性があるため、クエリのパフォーマンスに注意してください。
   - 以下の最適化を検討してください:
     - 適切なインデックスの使用（timestamp, level, component など）
     - 必要最小限のフィールドのみを取得
     - 検索条件の最適化（部分一致よりも前方一致を優先するなど）
     - 結果のキャッシュ（短時間のTTLで）

7. **ページネーション実装**:
   - 大量のログデータを効率的に取得するために、適切なページネーションを実装してください。
   - オフセットベースのページネーション（LIMIT/OFFSET）よりも、カーソルベースのページネーションを検討してください。
   - 特に日付範囲が広い場合や、検索条件が緩い場合は、結果セットが大きくなる可能性があります。

8. **検索機能の実装**:
   - `search` パラメータによる検索は、ログメッセージ内の部分一致として実装してください。
   - 大文字/小文字を区別しない検索を実装してください。
   - 検索パフォーマンスを向上させるために、全文検索インデックスの使用を検討してください。

9. **コンポーネントフィルタリング**:
   - 有効なコンポーネント名のリストを定義し、`component` パラメータの検証に使用することを検討してください。
   - コンポーネント名は一貫性を持って記録されるようにしてください。

10. **エラーハンドリング**:
    - ログストレージへのアクセスエラーは適切に処理し、明確なエラーメッセージを返してください。
    - 内部エラーの詳細はユーザーに公開せず、エラーログに記録してください。

11. **レスポンスサイズの制限**:
    - 大量のログデータがある場合、レスポンスサイズが大きくなる可能性があります。
    - `per_page` パラメータの最大値を適切に設定し、レスポンスサイズを制限してください。
    - 必要に応じて、詳細情報（`details` フィールド）のサイズを制限することを検討してください。

12. **日付フォーマット**:
    - すべての日時フィールド（timestamp）は ISO 8601 形式（YYYY-MM-DDThh:mm:ssZ）で返してください。
    - タイムゾーンは UTC を使用してください。

13. **ログレベルの階層的フィルタリング**:
    - ログレベルは階層的に考慮することを検討してください（例：`level=error` を指定した場合、error レベルのログのみを返す）。
    - オプションとして、階層的フィルタリングをサポートすることも検討してください（例：`level=warn` を指定した場合、warn と error レベルのログを返す）。

14. **リクエストIDによる関連ログの取得**:
    - オプションとして、特定の `request_id` に関連するすべてのログを取得する機能を検討してください。
    - これにより、特定のリクエストに関連する問題のトラブルシューティングが容易になります。