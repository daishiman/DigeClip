# タグ更新 API

- **HTTPメソッド**: `PUT`
- **エンドポイント**: `/api/admin/tags/[id]`
- **機能概要**: 既存のタグを更新
- **認証要否**: **要**(admin)

## リクエスト

**Path Parameter**:
- `id`: 更新するタグのID (必須)

**Request**: `IAdminUpdateTagRequest`
```ts
export interface IAdminUpdateTagRequest {
  name?: string;
  description?: string;
  color?: string;
  auto_tag?: boolean;
}
```

**例 (リクエストJSON)**
```jsonc
{
  "name": "ブロックチェーン技術",
  "description": "ブロックチェーンとWeb3技術に関する記事",
  "color": "#4B0082",
  "auto_tag": false
}
```

## レスポンス

**Response**: `IAdminUpdateTagResponse`
```ts
export interface IAdminUpdateTagResponse {
  id: number;
  name: string;
  description?: string;
  color?: string;
  auto_tag: boolean;
  created_at: string;
  updated_at: string;
}
```

**例 (レスポンスJSON)**
```jsonc
{
  "id": 5,
  "name": "ブロックチェーン技術",
  "description": "ブロックチェーンとWeb3技術に関する記事",
  "color": "#4B0082",
  "auto_tag": false,
  "created_at": "2025-03-15T10:30:00Z",
  "updated_at": "2025-03-15T14:22:35Z"
}
```

## エラー

**Error**: e.g. `404 Not Found`
```jsonc
{
  "error": {
    "code": "E4042",
    "message": "Tag not found"
  }
}
```

**Error**: e.g. `400 Bad Request`
```jsonc
{
  "error": {
    "code": "E4001",
    "message": "Invalid tag data",
    "details": {
      "color": "Invalid color format"
    }
  }
}
```

**Error**: e.g. `409 Conflict`
```jsonc
{
  "error": {
    "code": "E4091",
    "message": "Tag with this name already exists"
  }
}
```

## 実装上の注意事項

1. **認証・認可**:
   - 管理者権限を持つユーザーのみアクセス可能なエンドポイントです。
   - リクエスト処理前に必ず認証トークンを検証し、管理者権限を確認してください。

2. **パスパラメータの検証**:
   - `id` パラメータは数値であることを確認してください。
   - 不正な形式の場合は `400 Bad Request` を返してください。

3. **タグ存在確認**:
   - 指定された `id` のタグが存在するか確認してください。
   - 存在しない場合は `404 Not Found` エラーを返してください。

4. **入力検証**:
   - `name` が指定された場合、空でないことを確認してください。
   - `name` の長さに制限を設けることを検討してください（例：最大50文字）。
   - `color` が指定された場合、有効なカラーコード形式（例：`#RRGGBB`）であることを確認してください。
   - `description` が指定された場合、長さに制限を設けることを検討してください（例：最大200文字）。
   - 入力が無効な場合は、適切なエラーメッセージと共に `400 Bad Request` を返してください。

5. **重複チェック**:
   - `name` を変更する場合、同じ名前を持つ別のタグが既に存在しないか確認してください。
   - 大文字・小文字を区別しない比較を行うことを推奨します（例：`LOWER(name) = LOWER(?) AND id != ?`）。
   - 重複がある場合は `409 Conflict` エラーを返してください。

6. **部分更新の処理**:
   - このAPIは部分更新（PATCH的な動作）を行います。リクエストに含まれるフィールドのみを更新してください。
   - リクエストに含まれていないフィールドは現在の値を維持してください。
   - 特に `null` 値が明示的に指定された場合の処理方針（フィールドをクリアするか無視するか）を決定し、一貫して実装してください。

7. **データベース操作**:
   - タグ情報は `tags` テーブルで更新します。
   - `updated_at` フィールドには現在のUTC時刻を設定してください。
   - `created_at` フィールドは変更しないでください。

8. **トランザクション処理**:
   - データベースの更新操作はトランザクション内で実行し、エラー時にはロールバックしてください。
   - 特に将来的に関連テーブルの更新が必要になる場合は、トランザクションが重要です。

9. **楽観的ロック**:
   - 同時更新の競合を防ぐため、楽観的ロック（バージョン番号や更新タイムスタンプによる）の実装を検討してください。
   - 競合が検出された場合は `409 Conflict` エラーを返してください。

10. **日付フォーマット**:
    - すべての日時フィールド（created_at, updated_at）は ISO 8601 形式（YYYY-MM-DDThh:mm:ssZ）で返してください。
    - タイムゾーンは UTC を使用してください。

11. **エラーハンドリング**:
    - データベース接続エラーなどの内部エラーは `500 Internal Server Error` として処理し、詳細なエラーログを記録してください。
    - エラーメッセージにはセキュリティ上の機密情報（DB接続文字列など）を含めないよう注意してください。

12. **監査ログ**:
    - 誰がいつどのタグをどのように更新したかを記録する監査ログを実装してください。
    - ログには少なくとも、操作者ID、操作日時、対象タグID、変更されたフィールドを含めてください。

13. **キャッシュ管理**:
    - タグ情報のキャッシュがある場合、更新後にキャッシュを無効化または更新してください。
    - 特にタグ名が変更された場合は、関連するキャッシュも更新する必要があります。

14. **関連コンテンツへの影響**:
    - タグ名を変更した場合、そのタグが付けられたコンテンツの表示にも影響する可能性があります。
    - 必要に応じて、関連するコンテンツのキャッシュも更新してください。

15. **自動タグ付け機能の変更**:
    - `auto_tag` の値を変更する場合、既存のコンテンツに対する再処理が必要かどうかを検討してください。
    - 特に `true` から `false` に変更する場合、既存の自動タグ付けを維持するか削除するかの方針を決定してください。