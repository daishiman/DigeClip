---
## データベースの選定

### 1. 選定対象

- **RDB**: MySQL / PostgreSQL / SQL Server 等
- **NoSQL**: MongoDB / Firebase Realtime DB / DynamoDB 等
- **DBaaS**: Supabase / PlanetScale / MongoDB Atlas 等

お金をかけず、経験の浅いエンジニアでも導入・運用しやすいことを最優先に、**無料枠があり、学習コストが低い**サービスを中心に検討します。

---

### 2. 選定基準

1. **トランザクションの重要度**
   - ユーザーが閲覧するデータは整合性がそこまで厳格ではなくても可
   - しかし、AIモデル設定や管理情報、要約結果は**一貫性**が必要

2. **データ量の見込み**
   - 新着コンテンツの本文/字幕テキスト、要約結果などが増加する可能性あり
   - ただし初期は中～小規模 (数万レコード程度) で収まる見込み

3. **拡張性 (スケールアウト)**
   - 将来、動画数/論文数が莫大になった場合に対応
   - シャーディングやレプリケーションのオプション

4. **導入・運用コスト**
   - 無料枠の有無、または安価なプランがあるか
   - 経験の浅いエンジニアでも簡単に管理できるGUI or CLI

5. **コミュニティ・サポート**
   - エラーや不明点が出たときに解決しやすい
   - ドキュメントやチュートリアルが充実

---

### 3. 結論と理由

- **採用DB**: **Supabase (PostgreSQL)**
  1. **理由:**
     - **無料枠**があり、初期コストゼロで始められる
     - 本質は PostgreSQL ベースなので RDB の一貫性を維持できる
     - ブラウザで操作できる **Supabase Studio** があり、初心者でも GUI で確認・編集が容易
     - 認証やリストの閲覧にも組込み機能がある (必要に応じて活用)
     - 将来的に**有料プラン**へのアップグレードや**Vercel/Edge Functions**との親和性も高い

- **補足**:
  - NoSQL (例: MongoDB) も検討したが、要約結果やタグとの関連を考慮し、**リレーションが扱いやすい** PostgreSQL 系を優先
  - PlanetScale (MySQL) なども選択肢に入るが、Supabase の UI がより初心者向けと判断

---

### 4. 今後の拡張可能性

1. **スケールアウト**
   - Supabase の有料プラン / PostgreSQL のスケーラビリティ (読み込みレプリカ等)
   - データ量増加時もプラン変更だけで対応可能

2. **シャーディング / レプリケーション**
   - 大規模負荷が想定される場合、PostgreSQL でシャーディング可能 (将来検討)
   - まずは無料枠で簡単に始め、需要に応じてオートスケール

3. **バックアップ / 監査**
   - Supabase が自動バックアップを提供（プランによる）
   - 重要データ（AIモデル設定や要約履歴）は適宜エクスポート検討

4. **柔軟な拡張**
   - 新テーブル（例: ユーザーアクティビティログ、翻訳データ等）の追加が容易
   - GraphQL アドオンや Storage 機能など Supabase の拡張機能も順次活用可

---

### 5. データベース運用管理

1. **マイグレーション管理**
   - **ツール**: Prisma を使用してマイグレーションを管理
   - **開発環境での変更手順**:
     1. スキーマ変更: `schema.prisma` ファイルを編集
     2. マイグレーション作成: `npx prisma migrate dev --name 変更内容の説明`
     3. 型の更新: `npx prisma generate`
   - **本番環境への適用**:
     1. 環境変数設定: `.env` ファイルで `DATABASE_URL` を本番データベースに設定
     2. マイグレーション適用: `npx prisma migrate deploy`
     3. 注意: 本番適用前に必ずバックアップを取得すること
   - **ロールバック方法**:
     1. バックアップからの復元が基本
     2. 必要に応じて前のマイグレーションに戻す操作を新たなマイグレーションとして作成

2. **バックアップと復元**
   - **定期バックアップ**:
     - Supabase コンソールの「Backups」機能で自動バックアップ (無料プランでは限定機能)
     - 重要データは定期的に CSV/JSON 形式でエクスポート (管理画面から手動実行)
   - **手動バックアップ**:
     - Supabase CLI: `supabase db dump -f backup.sql`
     - または PostgreSQL 直接アクセス: `pg_dump -U postgres -h db.xxxx.supabase.co -p 5432 postgres > backup.sql`
   - **復元手順**:
     - Supabase コンソールからバックアップ選択して復元
     - または CLI/pg_restore で復元: `psql -U postgres -h db.xxxx.supabase.co -p 5432 postgres < backup.sql`

3. **環境管理**
   - **環境分離**:
     - 開発環境: 開発用Supabaseプロジェクト (`digeclip-dev`)
     - テスト環境: モックまたは一時データベース (テスト用)
     - 本番環境: 本番用Supabaseプロジェクト (`digeclip-prod`)
   - **環境変数管理**:
     - 開発環境: `.env.development` ファイルで管理
     - 本番環境: `.env.production` ファイルで管理
     - テスト環境: `jest.setup.js` 内のモック設定
   - **環境切替**:
     - `npm run use:dev`: 開発環境に切り替え
     - `npm run use:prod`: 本番環境に切り替え
   - **環境検出**:
     - `constants.ts` の関数で環境を自動判別
     - `supabase.ts` で環境に応じた接続先を選択
   - **CI/CD連携**:
     - GitHub Actionsワークフローでシークレットとして環境変数を管理
     - 開発環境: `DEV_SUPABASE_URL`, `DEV_SUPABASE_ANON_KEY`
     - 本番環境: `PROD_SUPABASE_URL`, `PROD_SUPABASE_ANON_KEY`

4. **セキュリティ管理**
   - **APIキー管理**:
     - Supabase のサービスロールキーは厳重に管理
     - アプリケーションでは匿名ロールまたは認証済みロールを使用
   - **RLS (Row Level Security)**:
     - テーブルごとに適切な RLS ポリシーを設定
     - 機密データへのアクセス制限を実装
   - **暗号化**:
     - API キーなどの機密情報は暗号化して保存
     - PgCrypto 拡張機能を使用した列レベルの暗号化も検討

5. **監視とトラブルシューティング**
   - **パフォーマンス監視**:
     - Supabase ダッシュボードでクエリパフォーマンスを確認
     - 遅いクエリの特定と最適化
   - **エラー対応**:
     - マイグレーションエラー: エラーログを確認し、問題箇所を修正
     - 接続エラー: ネットワーク設定や認証情報の確認
     - クエリエラー: SQL 構文やスキーマの整合性をチェック

---

**まとめ**
- **Supabase** (PostgreSQL) を採用することで、**お金をかけず**に**初心者が始めやすい**DB環境を構築可能。
- Prisma によるマイグレーション管理で安全かつ効率的なスキーマ変更を実現。
- 適切なバックアップ戦略と環境管理で、データの安全性を確保。
- 将来的に大規模化した際もアップグレードやレプリケーションで対応できるため、**拡張性**にも優れる。
- 別の DBaaS への移行も PostgreSQL ならある程度容易なため、**リスク低減**にもつながる。
```