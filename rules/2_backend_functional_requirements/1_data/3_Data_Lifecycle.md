## データライフサイクル (保存期間・バックアップ)

### 1. データ保存期間

**概要:**
本システムでは、**お金をかけずに、経験の浅いエンジニアでも**運用しやすいよう、**保存期間を無期限**とします。
データが増えすぎた場合や運用上の問題が出てきた場合、将来的に手動/自動での削除やアーカイブ機能を追加検討します。

1. **ユーザー情報 (users テーブル)**
   - **保存期間:** **無期限**
   - **削除ポリシー:** 不要になったユーザー (退職/退会など) を手動で削除
   - **将来拡張:** GDPR等対応が必要な場合、自動削除ルールを検討

2. **取得したコンテンツ (contents テーブル)**
   - **保存期間:** **無期限**
   - **削除ポリシー:** 現時点では削除/アーカイブの運用を行わない
   - **将来拡張:** データ量が大きくなり過ぎた場合、古いデータを手動 or 自動で削除/アーカイブ

3. **要約結果 (summaries テーブル)**
   - **保存期間:** **無期限** (コンテンツと連動)
   - **段階的な要約** (概要/見出し/詳細など) もすべて保持
   - **将来拡張:** 量が増加し過ぎたら古い要約を手動/自動で整理

4. **通知履歴 (notifications テーブル)**
   - **保存期間:** **無期限**
   - **用途:** トラブル調査, 通知送信状況確認
   - **将来拡張:** 大量データによるパフォーマンス懸念が出た際に別テーブル or ログ管理システムへ移行

5. **ログ情報 (DB操作ログ / アクセスログ等)**
   - **保存場所:** Supabase のログ or 外部ロギングサービス
   - **保存期間:** デフォルト(無期限) / サービス仕様上の最大期間
   - **将来拡張:** 有料プランや外部ツールで期限設定を行う可能性

---

### 2. バックアップポリシー

1. **フルバックアップ**
   - **取得頻度:** 原則1日1回 (夜間) を理想とするが、無料枠制限に応じて調整
   - **保存先:** Supabase の自動バックアップ or 手動ダンプ
   - **保存期間:** Supabase で提供される範囲内
   - **運用方法:**
     - **開発環境:** 必要に応じて手動バックアップ
     - **本番環境:** 毎日夜間に自動バックアップ（可能であれば）
     - **責任者:** システム管理者が定期確認
     - **確認事項:** バックアップログ、エラー通知の確認

2. **増分バックアップ (将来検討)**
   - 初期は不要
   - 大規模化や可用性要件が上がった場合に導入を検討

3. **オフライン/外部へのエクスポート**
   - **頻度:** 重要な設定変更時、または月1回程度
   - **対象データ:**
     - 重要データ(要約/AIモデル設定など)を手動でエクスポート
     - 特に暗号化したAPIキー等は念のため別途バックアップ
   - **保存先:** ローカルストレージ、クラウドストレージ（S3、Dropboxなど）
   - **形式:** CSV、JSON、SQLダンプなど
   - **手順:**
     1. Supabaseダッシュボードからテーブルごとにエクスポート
     2. または `supabase db dump` コマンドでエクスポート
     3. 暗号化またはパスワード保護してストレージに保存
     4. 定期的に復元テストを実施

---

### 3. リカバリ手順

1. **Supabaseコンソールでリストア**
   - **シナリオ:** データ破損、誤った操作、マイグレーション失敗など
   - **手順:**
     1. Supabaseダッシュボードにログイン
     2. 「Settings」→「Database」→「Backups」へ移動
     3. バックアップ一覧から必要な日時を選択
     4. リストア操作を実行
     5. リストア完了後、データ整合性を確認
   - **注意事項:** リストア中はサービスが一時的に停止する可能性あり
   - **復旧時間の目安:** 10分〜1時間（データ量により変動）

2. **手動ダンプファイルの適用** (大規模運用時)
   - **シナリオ:** Supabaseのリストア機能が使えない場合や部分的な復元
   - **必要ツール:** PostgreSQL CLI (psql, pg_restore)
   - **手順:**
     1. ダンプファイルを用意（事前バックアップから）
     2. テスト環境で復元テスト: `pg_restore -U postgres -h host -d dbname backup.sql`
     3. 問題なければ本番環境で同様に実行
     4. テーブル単位の復元も可能: `psql -U postgres -h host -d dbname -c "COPY table FROM 'file.csv' CSV HEADER"`
   - **障害発生時の対応チーム:** 技術リード + DBに詳しいメンバー

3. **DR(ディザスタリカバリ)計画** (将来拡張)
   - 無料枠段階では基本的に考慮しない
   - 本格的な可用性要件が出てきた場合、有料プランや別リージョンレプリケーションを導入

4. **マイグレーションの失敗対応**
   - **シナリオ:** Prismaマイグレーション実行時のエラー
   - **対応手順:**
     1. エラーログを確認し問題箇所を特定
     2. 開発環境でマイグレーションをロールバック（新しいマイグレーションファイルで元に戻す）
     3. 修正したマイグレーションを作成
     4. 本番環境適用前に必ずテスト環境で検証
   - **緊急時のロールバック:** バックアップからのリストアが最も確実

---

### 4. データ削除・アーカイブ

1. **削除のタイミング**
   - 当面は**無期限**保存を基本方針
   - 手動で不要データを削除 or アーカイブする運用

2. **アーカイブ先**
   - Supabase の別テーブルに移行
   - ローカルCSV/Excel or S3 など外部ストレージへのエクスポート
   - 大量データの場合にのみ対応検討

3. **手動/自動の手順**
   - 初期リリースでは**手動運用**を前提とし、管理者がスクリプトやSupabaseコンソールで削除
   - 将来的に要望があれば**Vercel Cron** 等で自動化

---

### 5. 環境別データ管理方針

1. **開発環境** (digeclip-dev Supabaseプロジェクト)
   - **データ特性:** テストデータ中心、開発用シードデータ
   - **環境変数設定:** `.env.development`ファイルで管理
   - **バックアップ頻度:** 大きな変更時のみ手動バックアップ
   - **復元ポリシー:** 問題発生時に手動復元
   - **アクセス権限:** 開発チーム全員がフル権限
   - **環境切替:** `npm run use:dev`コマンドでアクティブ化

2. **テスト環境** (モック/一時データベース)
   - **データ特性:** モックデータまたは開発環境のコピー
   - **環境変数設定:** `jest.setup.js`内のモック設定
   - **バックアップ頻度:** テスト前後に必要に応じて
   - **復元ポリシー:** テストケース実行ごとに自動リセット
   - **アクセス権限:** CI/CDパイプラインとテスト実行者
   - **実装方法:** `isTestEnvironment()`関数でテスト環境検出

3. **本番環境** (digeclip-prod Supabaseプロジェクト)
   - **データ特性:** 実データ、高保全性
   - **環境変数設定:** `.env.production`ファイルで管理
   - **バックアップ頻度:** 日次（自動）+ 大きな変更前（手動）
   - **復元ポリシー:** 障害時のみ、管理者承認必須
   - **アクセス権限:** 厳格に制限（管理者のみデータ変更可）
   - **監視体制:** パフォーマンス指標、エラーログを定期確認
   - **環境切替:** `npm run use:prod`コマンドでアクティブ化

4. **CI/CD連携**
   - **開発環境デプロイ:**
     - `preview-deploy.yml`ワークフローで`DEV_SUPABASE_*`シークレット使用
     - 開発ブランチからのPRでプレビュー環境自動デプロイ
   - **本番環境デプロイ:**
     - `deploy-production.yml`ワークフローで`PROD_SUPABASE_*`シークレット使用
     - 本番ブランチへのマージで本番環境自動デプロイ
   - **テスト実行時:**
     - `test.yml`ワークフローでモック環境を使用
     - データベース操作はモックに置き換え

5. **環境検出ロジック**
   - **開発/本番判定:** `constants.ts`内の関数で自動検出
   - **Supabase接続:** `supabase.ts`で環境に応じた接続先を選択
   - **フォールバック:** 環境変数取得エラー時は安全なデフォルト値を使用

---

**まとめ**
- **無期限保存**を基本とし、将来的に肥大化した場合に備えて**手動/自動アーカイブ**の仕組みを追加できる設計
- バックアップは**Supabaseの自動バックアップ**と**手動ダンプ**を組み合わせ、**簡易リカバリ**ができる体制
- 環境ごとに適切なデータ管理ポリシーを設定し、本番環境のデータ保全性を最重視
- **マイグレーション失敗時**の対応手順を明確化し、迅速な復旧を可能に
- 大規模/高可用性要件が出たら**有料プラン**や**別リージョンレプリケーション**を視野に入れる
- **初心者にも分かりやすい**運用フローで、段階的に拡張できる方針とする。