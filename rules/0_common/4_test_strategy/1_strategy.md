# テスト戦略

このドキュメントでは、プロジェクト全体のテスト戦略を定義します。適切なテスト戦略を持つことで、コードの品質を確保し、バグの早期発見と修正が可能になります。

## テストの種類

以下の3種類のテストを実施します：

1. **単体テスト (Unit Tests)**
   - 個々のコンポーネント、関数、クラスが仕様通りに動作することを確認する
   - 外部依存を持たない、または依存をモック化して行うテスト
   - 例：UI コンポーネントの単体テスト、ユーティリティ関数のテスト

2. **統合テスト (Integration Tests)**
   - 複数のモジュールが連携して正しく動作することを確認する
   - API エンドポイントとデータベースの連携、フロントエンドとバックエンドの連携など
   - 例：API リクエストとレスポンスのテスト、データベース操作のテスト

3. **E2E テスト (End-to-End Tests)**
   - 実際のユーザーシナリオに沿ってアプリケーション全体が正しく動作することを確認する
   - フロントエンドとバックエンドの統合、データベースとの連携など、システム全体の動作を検証
   - 例：ユーザーログインフロー、コンテンツ作成フローなど

## テストの責任範囲

| テストの種類 | 責任範囲 | テストツール |
|------------|---------|------------|
| 単体テスト | コンポーネント、関数、クラスの個別機能 | Jest, React Testing Library |
| 統合テスト | モジュール間の連携、API との連携 | Jest, Supertest, MSW |
| E2E テスト | ユーザーフロー、システム全体の動作 | Playwright または Cypress |

## テストの優先度

テストの優先度は以下の順で行います：

1. **重要なビジネスロジック**
   - ユーザー認証、データ処理、重要な計算など
   - 高いテストカバレッジを目指す（80%以上）

2. **UIコンポーネント**
   - 共通UI コンポーネント（ボタン、フォーム、カードなど）
   - 複雑な UI コンポーネント

3. **API エンドポイント**
   - データ操作（CRUD）
   - 認証・認可

4. **ユーザーフロー**
   - ログインフロー
   - コンテンツ作成・編集フロー
   - 検索・フィルタリングフロー

## テストディレクトリ構造

テストコードは、以下のディレクトリ構造に従って配置します：

```
/digeclip/src
  └─ /__tests__                    # テストコード
      ├─ /unit                     # 単体テスト
      │   ├─ /components           # コンポーネントの単体テスト
      │   │   ├─ /ui               # UIコンポーネント
      │   │   ├─ /layout           # レイアウトコンポーネント
      │   │   └─ /features         # 機能別コンポーネント
      │   ├─ /hooks                # カスタムフックのテスト
      │   ├─ /lib                  # ユーティリティのテスト
      │   │   ├─ /services         # サービスのテスト
      │   │   ├─ /utils            # ユーティリティのテスト
      │   │   └─ ...
      │   └─ /context              # コンテキストのテスト
      │
      ├─ /integration              # 統合テスト
      │   ├─ /api                  # API統合テスト
      │   ├─ /services             # サービス統合テスト
      │   └─ /features             # 機能結合テスト
      │
      ├─ /e2e                      # E2Eテスト
      │   ├─ /auth                 # 認証関連E2Eテスト
      │   ├─ /contents             # コンテンツ関連E2Eテスト
      │   └─ /settings             # 設定関連E2Eテスト
      │
      ├─ /utils                    # テスト用ユーティリティ
      │   ├─ test-utils.ts         # テスト共通ユーティリティ
      │   ├─ renderWithProviders.tsx # プロバイダ付きのレンダリングヘルパー
      │   └─ ...
      │
      └─ /mocks                    # モックデータとハンドラー
          ├─ /data                 # モックデータ
          ├─ /handlers             # MSWリクエストハンドラー
          └─ /server.ts            # MSWサーバー設定
```

詳細なテストディレクトリ構造については、[テストディレクトリ構造](./2_test_structure.md)を参照してください。

## テスト命名規則

- **テストファイル**: `[対象ファイル名].test.ts` または `[対象ファイル名].test.tsx`
- **テストスイート**: `describe('[コンポーネント/関数名]', () => { ... })`
- **テストケース**: `it('[期待する動作]', () => { ... })` または `test('[期待する動作]', () => { ... })`

## テストツール

### 単体テスト・統合テスト

- **Jest**: JavaScript のテストランナー
- **React Testing Library**: React コンポーネントのテスト
- **MSW (Mock Service Worker)**: API リクエストのモック

### E2E テスト

- **Playwright**: Microsoft が開発した E2E テストフレームワーク
- **Cypress**: JavaScript ベースの E2E テストフレームワーク

詳細なテストツールについては、以下のドキュメントを参照してください：

- [Jest](./2_test_tools/1_jest.md)
- [Cypress と Playwright](./2_test_tools/2_cypress_playwright.md)

## テストカバレッジ

テストカバレッジの目標は以下の通りです：

- **単体テスト**: 80% 以上
- **統合テスト**: 主要な機能・フローをカバー
- **E2E テスト**: 重要なユーザーフローをカバー

テストカバレッジレポートは CI/CD パイプラインで自動的に生成し、一定以下になった場合はビルドを失敗させます。

## テスト環境

### 開発環境

- **環境変数**: `.env.test` ファイルを使用
- **データベース**: テスト用データベースを使用
- **API**: モック化または専用のテスト環境を使用

### CI環境

- GitHub Actions を使用して自動テストを実行
- Pull Request 時に全テストを実行
- マージ前にテストが全て成功していることを確認

## テスト実行コマンド

```bash
# すべてのテストを実行
npm test

# 単体テストのみ実行
npm run test:unit

# 統合テストのみ実行
npm run test:integration

# E2E テストのみ実行
npm run test:e2e

# テストカバレッジを計測
npm run test:coverage
```

## テスト作成のガイドライン

### 全般的なガイドライン

1. 各テストは独立して実行できるようにする
2. テストは明確で理解しやすいものにする
3. テストケースは具体的な動作を検証する
4. モックは必要最小限にする

### 単体テストのガイドライン

詳細は [単体テスト](./1_test_types/1_unit_tests.md) を参照してください。

### 統合テストのガイドライン

詳細は [統合テスト](./1_test_types/2_integration_tests.md) を参照してください。

### E2E テストのガイドライン

詳細は [E2E テスト](./1_test_types/3_e2e_tests.md) を参照してください。

## 継続的インテグレーション

テストは継続的インテグレーション (CI) パイプラインの一部として自動的に実行されます。

1. **プルリクエスト時**:
   - 単体テスト
   - 統合テスト
   - テストカバレッジの測定

2. **マージ前**:
   - E2E テスト

3. **定期的なスケジュール**:
   - 全テスト
   - パフォーマンステスト

## テスト戦略の見直し

テスト戦略は定期的に見直し、必要に応じて更新します。以下のタイミングで見直しを行います：

1. 四半期ごと
2. 大きな機能追加や変更がある場合
3. テストに関する問題が発生した場合