# テスト戦略

このドキュメントでは、プロジェクト全体のテスト戦略を定義します。テスト戦略は、アプリケーションの品質を確保し、バグを早期に発見するために重要です。

## テストの種類

プロジェクトでは、以下の3種類のテストを実施します：

1. **単体テスト (Unit Tests)**
   - 個々の関数やコンポーネントが期待通りに動作することを確認する
   - 詳細: [単体テスト](./1_test_types/1_unit_tests.md)

2. **統合テスト (Integration Tests)**
   - 複数のモジュールやコンポーネントが連携して正しく動作することを確認する
   - 詳細: [統合テスト](./1_test_types/2_integration_tests.md)

3. **E2Eテスト (End-to-End Tests)**
   - アプリケーション全体が実際のユーザーシナリオに沿って正しく動作することを確認する
   - 詳細: [E2Eテスト](./1_test_types/3_e2e_tests.md)

## テストピラミッド

テストの量と実行頻度は、テストピラミッドに従って設計します：

```
    /\
   /  \
  /E2E \
 /------\
/統合テスト\
/----------\
/  単体テスト \
/--------------\
```

- **単体テスト**: 最も多く、最も頻繁に実行する
- **統合テスト**: 中程度の量と頻度
- **E2Eテスト**: 最も少なく、最も頻度が低い

## テストツール

プロジェクトでは、以下のテストツールを使用します：

1. **Jest**
   - 単体テストと統合テストに使用
   - 詳細: [Jest](./2_test_tools/1_jest.md)

2. **React Testing Library**
   - Reactコンポーネントのテストに使用
   - Jestと組み合わせて使用

3. **Cypress / Playwright**
   - E2Eテストに使用
   - 詳細: [Cypress と Playwright](./2_test_tools/2_cypress_playwright.md)

## テストディレクトリ構造

テストコードは、以下のディレクトリ構造に従って配置します：

```
/src
  ├─ /lib                          # ユーティリティと共通関数
  │   ├─ /openai.ts                # OpenAI関連機能
  │   ├─ /discord.ts               # Discord関連機能
  │   ├─ /supabase.ts              # Supabase関連機能
  │   └─ /__tests__                # libディレクトリのテスト
  │       ├─ /openai.test.ts       # OpenAIのテスト
  │       ├─ /discord.test.ts      # Discordのテスト
  │       └─ /supabase.test.ts     # Supabaseのテスト
  │
  ├─ /components                   # コンポーネント
  │   ├─ /ui                       # UIコンポーネント
  │   └─ /__tests__                # コンポーネントのテスト
  │       └─ /ui                   # UIコンポーネントのテスト
  │
  ├─ /app                          # Next.jsのApp Router
  │   └─ /__tests__                # アプリケーションのテスト
  │
  └─ /__tests__                    # 全体的なテスト
      ├─ /utils                    # テスト用ユーティリティ
      ├─ /e2e                      # E2Eテスト
      └─ /integration              # 統合テスト
```

## テスト実行

テストは、以下のコマンドで実行します：

```bash
# すべてのテストを実行
npm test

# 単体テストのみ実行
npm run test:unit

# 統合テストのみ実行
npm run test:integration

# E2Eテストのみ実行
npm run test:e2e

# テストカバレッジを計測
npm run test:coverage
```

## CI/CDとの統合

テストは、CI/CDパイプラインに統合します：

1. **プルリクエスト時**
   - 単体テストと統合テストを実行
   - テストカバレッジを計測

2. **メインブランチへのマージ時**
   - 単体テスト、統合テスト、E2Eテストを実行
   - テストカバレッジを計測

3. **デプロイ前**
   - すべてのテストが成功していることを確認

## テストカバレッジ

テストカバレッジは、以下の基準を目標とします：

- **単体テスト**
  - 関数/メソッド: 80%以上
  - 分岐カバレッジ: 70%以上
  - 行カバレッジ: 75%以上

- **統合テスト**
  - 主要な機能フロー: 90%以上

- **E2Eテスト**
  - 重要なユーザーフロー: 100%

## テスト環境

テストは、以下の環境で実行します：

1. **ローカル開発環境**
   - 開発者のマシン上で実行
   - 単体テストと統合テストを実行

2. **CI環境**
   - GitHub Actionsなどで実行
   - すべてのテストを実行

3. **ステージング環境**
   - 本番環境に近い環境で実行
   - E2Eテストを実行

## テストデータ

テストデータは、以下の方針で管理します：

1. **モックデータ**
   - 単体テストと統合テストで使用
   - `src/__tests__/utils/test-utils.ts` に定義

2. **テスト用データベース**
   - 統合テストとE2Eテストで使用
   - 本番環境とは別のデータベースを使用

3. **フィクスチャ**
   - E2Eテストで使用
   - `src/__tests__/e2e/fixtures/` に配置

## テスト作成のガイドライン

1. **テストファーストの原則**
   - 可能な限り、コードを書く前にテストを書く
   - TDD (Test-Driven Development) の考え方を取り入れる

2. **テストの独立性**
   - 各テストは独立して実行できるようにする
   - テスト間の依存関係を作らない

3. **テストの可読性**
   - テストは明確で理解しやすいものにする
   - テストケースは具体的な動作を検証する

4. **テストの保守性**
   - テストコードも本番コードと同様に保守する
   - リファクタリングの際はテストも更新する