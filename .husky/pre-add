#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 git add前にテストを実行しています..."

# プロジェクトのルートディレクトリに移動
cd "$(git rev-parse --show-toplevel)"

# digeclipディレクトリに移動
cd digeclip

# 変更されたファイルを取得
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.tsx?$|\.jsx?$')

if [ -z "$staged_files" ]; then
  echo "JavaScriptまたはTypeScriptファイルが変更されていません。テストをスキップします。"
  exit 0
fi

# テスト実行
echo "変更に関連するテストを実行中..."
npm test -- --findRelatedTests $staged_files

# 終了コードを保存
test_exit_code=$?

# 結果の表示
if [ $test_exit_code -ne 0 ]; then
  echo "❌ テストに失敗しました。修正してから再度 git add を実行してください。"
  exit 1
else
  echo "✅ テストが成功しました。git add を続行します。"
  exit 0
fi