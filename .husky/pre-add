#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” git addå‰ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)"

# digeclipãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd digeclip

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.tsx?$|\.jsx?$')

if [ -z "$staged_files" ]; then
  echo "JavaScriptã¾ãŸã¯TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
  exit 0
fi

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
echo "å¤‰æ›´ã«é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
npm test -- --findRelatedTests $staged_files

# çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜
test_exit_code=$?

# çµæœã®è¡¨ç¤º
if [ $test_exit_code -ne 0 ]; then
  echo "âŒ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ git add ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
  exit 1
else
  echo "âœ… ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸã€‚git add ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
  exit 0
fi